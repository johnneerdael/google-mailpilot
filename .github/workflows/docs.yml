name: Deploy Documentation

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - '.github/workflows/docs.yml'
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # Stable tags only (v1.2.3)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git operations

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: docs/package-lock.json

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Tag push: extract version from tag
            VERSION="${GITHUB_REF#refs/tags/}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            # Main branch push: use "latest"
            echo "version=latest" >> $GITHUB_OUTPUT
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        working-directory: docs
        run: npm ci

      - name: Build VitePress
        working-directory: docs
        env:
          # Dynamic base path based on deployment target
          # Main branch -> /Google-Workspace-Secretary-MCP/latest/
          # Tag -> /Google-Workspace-Secretary-MCP/v1.2.3/
          VITEPRESS_BASE: /Google-Workspace-Secretary-MCP/${{ steps.version.outputs.version }}/
        run: npm run build

      - name: Checkout gh-pages branch
        run: |
          # Create gh-pages if it doesn't exist
          git fetch origin gh-pages || git checkout --orphan gh-pages
          git checkout gh-pages || git checkout --orphan gh-pages

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Deploy version to gh-pages
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Remove old version if exists
          rm -rf "$VERSION"
          
          # Copy built site to version directory
          mkdir -p "$VERSION"
          cp -r docs/.vitepress/dist/* "$VERSION/"
          
          # Add to git
          git add "$VERSION"

      - name: Update versions.json
        run: |
          # Get all stable version tags (v*.*.*)
          STABLE_TAGS=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' | sort -V -r)
          
          # Build versions.json
          cat > versions.json << 'EOF'
          {
            "latest": {
              "version": "latest",
              "label": "Latest (main)",
              "path": "/Google-Workspace-Secretary-MCP/latest/"
            },
            "versions": [
          EOF
          
          FIRST=true
          for TAG in $STABLE_TAGS; do
            if [ "$FIRST" = false ]; then
              echo "," >> versions.json
            fi
            FIRST=false
            cat >> versions.json << EOF
              {
                "version": "$TAG",
                "label": "$TAG",
                "path": "/Google-Workspace-Secretary-MCP/$TAG/"
              }
          EOF
          done
          
          cat >> versions.json << 'EOF'
            ]
          }
          EOF
          
          git add versions.json

      - name: Create root redirect
        run: |
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta http-equiv="refresh" content="0; url=/Google-Workspace-Secretary-MCP/latest/">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Redirecting...</title>
            <script>
              window.location.href = '/Google-Workspace-Secretary-MCP/latest/';
            </script>
          </head>
          <body>
            <p>Redirecting to <a href="/Google-Workspace-Secretary-MCP/latest/">documentation</a>...</p>
          </body>
          </html>
          EOF
          
          git add index.html

      - name: Commit and push
        env:
          VERSION: ${{ steps.version.outputs.version }}
          IS_TAG: ${{ steps.version.outputs.is_tag }}
        run: |
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            if [ "$IS_TAG" = "true" ]; then
              git commit -m "docs: deploy version $VERSION"
            else
              git commit -m "docs: update latest documentation"
            fi
            git push origin gh-pages --force
          fi

      - name: Summary
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "âœ… Documentation deployed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: https://${{ github.repository_owner }}.github.io/Google-Workspace-Secretary-MCP/$VERSION/" >> $GITHUB_STEP_SUMMARY
