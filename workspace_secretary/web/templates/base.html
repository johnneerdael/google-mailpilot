<!DOCTYPE html>
<html lang="en" class="h-full {% if theme == 'dark' or (theme == 'system' and not theme) %}dark{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Secretary{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .email-content img { max-width: 100%; height: auto; }
        .email-content a { color: #60a5fa; text-decoration: underline; }
    </style>
</head>
<body class="h-full bg-gray-950 text-gray-100" x-data="{ darkMode: {% if theme == 'system' %}localStorage.getItem('darkMode') !== 'false'{% elif theme == 'dark' %}true{% else %}false{% endif %} }" x-init="if(!darkMode) document.documentElement.classList.remove('dark'); else document.documentElement.classList.add('dark')" :class="{ 'bg-gray-50 text-gray-900': !darkMode, 'bg-gray-950 text-gray-100': darkMode }">
    <div class="min-h-full">
        <nav class="bg-gray-900 border-b border-gray-800" :class="{ 'bg-white border-gray-200': !darkMode, 'bg-gray-900 border-gray-800': darkMode }">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <a href="/inbox" class="text-xl font-bold">
                                üìß Secretary
                            </a>
                        </div>
                        <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                            <a href="/inbox" class="border-primary inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                                Inbox
                            </a>
                            <a href="/calendar" class="border-transparent text-gray-400 hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" :class="{ 'text-gray-500 hover:text-gray-700': !darkMode, 'text-gray-400 hover:text-gray-200': darkMode }">
                                Calendar
                            </a>
                            <a href="/chat" class="border-transparent text-gray-400 hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" :class="{ 'text-gray-500 hover:text-gray-700': !darkMode, 'text-gray-400 hover:text-gray-200': darkMode }">
                                ü§ñ Assistant
                            </a>
                            <a href="/search" class="border-transparent text-gray-400 hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" :class="{ 'text-gray-500 hover:text-gray-700': !darkMode, 'text-gray-400 hover:text-gray-200': darkMode }">
                                Search
                            </a>
                            <a href="/settings" class="border-transparent text-gray-400 hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" :class="{ 'text-gray-500 hover:text-gray-700': !darkMode, 'text-gray-400 hover:text-gray-200': darkMode }">
                                ‚öôÔ∏è Settings
                            </a>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div x-data="notificationBell()" x-init="init()">
                            <button @click="togglePanel()" class="relative p-2 rounded-md text-gray-400 hover:bg-gray-800" :class="{ 'hover:bg-gray-100': !darkMode, 'hover:bg-gray-800': darkMode }">
                                <span>üîî</span>
                                <span x-show="unreadCount > 0" x-cloak 
                                      class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center"
                                      x-text="unreadCount > 9 ? '9+' : unreadCount"></span>
                            </button>
                            
                            <div x-show="showPanel" x-cloak @click.outside="showPanel = false"
                                 class="absolute right-4 mt-2 w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50">
                                <div class="p-3 border-b border-gray-700 flex items-center justify-between">
                                    <h3 class="font-medium text-white">Notifications</h3>
                                    <button @click="requestPermission()" x-show="!notificationsEnabled" 
                                            class="text-xs text-blue-400 hover:text-blue-300">
                                        Enable desktop notifications
                                    </button>
                                </div>
                                <div class="max-h-96 overflow-y-auto">
                                    <template x-if="notifications.length === 0">
                                        <div class="p-4 text-center text-gray-500 text-sm">
                                            No new notifications
                                        </div>
                                    </template>
                                    <template x-for="n in notifications" :key="n.uid">
                                        <a :href="'/thread/' + n.folder + '/' + n.uid" 
                                           class="block px-4 py-3 hover:bg-gray-700 border-b border-gray-700/50">
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="text-sm font-medium text-white truncate" x-text="n.from"></span>
                                                <span class="text-xs text-gray-500" x-text="formatTime(n.date)"></span>
                                            </div>
                                            <p class="text-sm text-gray-400 truncate" x-text="n.subject"></p>
                                        </a>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <button @click="darkMode = !darkMode; localStorage.setItem('darkMode', darkMode); if(darkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark')" 
                                class="p-2 rounded-md text-gray-400 hover:bg-gray-800" :class="{ 'hover:bg-gray-100': !darkMode, 'hover:bg-gray-800': darkMode }">
                            <span x-show="!darkMode">üåô</span>
                            <span x-show="darkMode" x-cloak>‚òÄÔ∏è</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            {% block content %}{% endblock %}
        </main>
    </div>

    <div id="loading" class="htmx-indicator fixed top-0 left-0 right-0 h-1 bg-primary animate-pulse"></div>
    
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    
    <script>
        // Global toast notification function
        window.showToast = function(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600',
                warning: 'bg-yellow-600'
            };
            
            toast.className = `${colors[type] || colors.info} text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
            toast.textContent = message;
            container.appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full');
            });
            
            // Auto-dismiss
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        };
        
        // HTMX event handlers for showing toasts on action completion
        document.body.addEventListener('htmx:afterRequest', function(event) {
            const xhr = event.detail.xhr;
            if (xhr && xhr.status >= 200 && xhr.status < 300) {
                // Check if response has a message
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.message) {
                        window.showToast(response.message, response.success ? 'success' : 'error');
                    }
                } catch (e) {
                    // Not JSON, ignore
                }
            }
        });
        
        document.body.addEventListener('htmx:responseError', function(event) {
            window.showToast('Action failed. Please try again.', 'error');
        });
        
        // Undo toast for delete operations
        window.showUndoToast = function(message, uid, fromFolder, toFolder) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            toast.className = 'bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full flex items-center justify-between space-x-4';
            toast.innerHTML = `
                <span>${message}</span>
                <button class="text-blue-400 hover:text-blue-300 font-medium underline" onclick="window.undoDelete('${uid}', '${toFolder}', '${fromFolder}', this.closest('div'))">
                    Undo
                </button>
            `;
            container.appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full');
            });
            
            // Auto-dismiss after 5 seconds (longer for undo)
            const timeout = setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    toast.remove();
                    window.location.href = '/inbox';
                }, 300);
            }, 5000);
            
            toast.dataset.timeout = timeout;
        };
        
        // Undo delete by moving back to original folder
        window.undoDelete = async function(uid, fromFolder, toFolder, toastEl) {
            clearTimeout(parseInt(toastEl.dataset.timeout));
            
            try {
                const response = await fetch(`/api/email/move/${encodeURIComponent(fromFolder)}/${uid}?destination=${encodeURIComponent(toFolder)}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    window.showToast('Undo successful', 'success');
                    toastEl.remove();
                    // Stay on current page instead of redirecting
                } else {
                    window.showToast('Undo failed', 'error');
                }
            } catch (e) {
                window.showToast('Undo failed', 'error');
            }
        };
        
        function notificationBell() {
            return {
                showPanel: false,
                notifications: [],
                unreadCount: 0,
                notificationsEnabled: false,
                checkInterval: null,
                
                init() {
                    this.notificationsEnabled = Notification.permission === 'granted';
                    this.checkForNew();
                    this.checkInterval = setInterval(() => this.checkForNew(), 30000);
                },
                
                togglePanel() {
                    this.showPanel = !this.showPanel;
                },
                
                async requestPermission() {
                    const permission = await Notification.requestPermission();
                    this.notificationsEnabled = permission === 'granted';
                    if (this.notificationsEnabled) {
                        window.showToast('Desktop notifications enabled', 'success');
                    }
                },
                
                async checkForNew() {
                    try {
                        const response = await fetch('/api/notifications/check');
                        const data = await response.json();
                        
                        if (data.new_emails && data.new_emails.length > 0) {
                            this.notifications = [...data.new_emails, ...this.notifications].slice(0, 20);
                            this.unreadCount = data.count;
                            
                            if (this.notificationsEnabled && data.new_emails.length > 0) {
                                const email = data.new_emails[0];
                                new Notification('New Email', {
                                    body: `${email.from}: ${email.subject}`,
                                    icon: '/static/icon.png',
                                    tag: 'email-' + email.uid
                                });
                            }
                        }
                    } catch (e) {
                        console.error('Failed to check notifications:', e);
                    }
                },
                
                formatTime(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    const now = new Date();
                    const diff = now - date;
                    
                    if (diff < 60000) return 'Just now';
                    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
                    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
                    return date.toLocaleDateString();
                }
            };
        }
    </script>
</body>
</html>
