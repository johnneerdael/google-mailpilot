<!DOCTYPE html>
<html lang="en" class="h-full {% if theme == 'dark' or (theme == 'system' and not theme) %}dark{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Secretary{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <meta name="csrf-token" content="{{ csrf_token or '' }}">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .email-content img { max-width: 100%; height: auto; }
        .email-content a { color: #60a5fa; text-decoration: underline; }
        .search-highlight { background-color: #fbbf24; color: #000; padding: 2px 0; }
        .search-highlight.current-match { background-color: #f97316; color: #fff; }
    </style>

</head>
<body class="h-full bg-gray-950 text-gray-100" x-data="{ 
    darkMode: {% if theme == 'system' %}window.matchMedia('(prefers-color-scheme: dark)').matches{% elif theme == 'dark' %}true{% else %}false{% endif %},
    async toggleTheme() {
        this.darkMode = !this.darkMode;
        if(this.darkMode) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        try {
            const csrfToken = document.querySelector('meta[name=csrf-token]')?.content;
            await fetch('/api/settings/ui', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify({
                    theme: this.darkMode ? 'dark' : 'light',
                    density: '{{ density }}'
                })
            });
        } catch (e) {
            console.error('Failed to save theme preference:', e);
        }
    }
}" x-init="if(!darkMode) document.documentElement.classList.remove('dark'); else document.documentElement.classList.add('dark')" :class="{ 'bg-gray-50 text-gray-900': !darkMode, 'bg-gray-950 text-gray-100': darkMode }">
    <div class="min-h-full">
        <nav class="bg-gray-900 border-b border-gray-800" :class="{ 'bg-white border-gray-200': !darkMode, 'bg-gray-900 border-gray-800': darkMode }">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <a href="/inbox" class="text-xl font-bold">
                                üìß Secretary
                            </a>
                        </div>
                        <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                            <a href="/inbox" class="border-primary inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                                Inbox
                            </a>
                            <a href="/calendar" class="border-transparent text-gray-400 hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" :class="{ 'text-gray-500 hover:text-gray-700': !darkMode, 'text-gray-400 hover:text-gray-200': darkMode }">
                                Calendar
                            </a>
                            <a href="/contacts" class="border-transparent text-gray-400 hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" :class="{ 'text-gray-500 hover:text-gray-700': !darkMode, 'text-gray-400 hover:text-gray-200': darkMode }">
                                Contacts
                            </a>
                            <a href="/chat" class="border-transparent text-gray-400 hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" :class="{ 'text-gray-500 hover:text-gray-700': !darkMode, 'text-gray-400 hover:text-gray-200': darkMode }">
                                ü§ñ Assistant
                            </a>
                            <a href="/search" class="border-transparent text-gray-400 hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" :class="{ 'text-gray-500 hover:text-gray-700': !darkMode, 'text-gray-400 hover:text-gray-200': darkMode }">
                                Search
                            </a>
                            <a href="/settings" class="border-transparent text-gray-400 hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" :class="{ 'text-gray-500 hover:text-gray-700': !darkMode, 'text-gray-400 hover:text-gray-200': darkMode }">
                                ‚öôÔ∏è Settings
                            </a>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div x-data="notificationBell()" x-init="init()">
                            <button @click="togglePanel()" class="relative p-2 rounded-md text-gray-400 hover:bg-gray-800" :class="{ 'hover:bg-gray-100': !darkMode, 'hover:bg-gray-800': darkMode }">
                                <span>üîî</span>
                                <span x-show="unreadCount > 0" x-cloak 
                                      class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center"
                                      x-text="unreadCount > 9 ? '9+' : unreadCount"></span>
                            </button>
                            
                            <div x-show="showPanel" x-cloak @click.outside="showPanel = false"
                                 class="absolute right-4 mt-2 w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50">
                                <div class="p-3 border-b border-gray-700 flex items-center justify-between">
                                    <h3 class="font-medium text-white">Notifications</h3>
                                    <button @click="requestPermission()" x-show="!notificationsEnabled" 
                                            class="text-xs text-blue-400 hover:text-blue-300">
                                        Enable desktop notifications
                                    </button>
                                </div>
                                <div class="max-h-96 overflow-y-auto">
                                    <template x-if="notifications.length === 0">
                                        <div class="p-4 text-center text-gray-500 text-sm">
                                            No new notifications
                                        </div>
                                    </template>
                                    <template x-for="n in notifications" :key="n.uid || n.id">
                                        <div>
                                            <!-- Email notification -->
                                            <template x-if="n.type === 'email'">
                                                <a :href="'/thread/' + n.folder + '/' + n.uid"
                                                   class="block px-4 py-3 hover:bg-gray-700 border-b border-gray-700/50">
                                                    <div class="flex items-center justify-between mb-1">
                                                        <span class="text-sm font-medium text-white truncate" x-text="n.from"></span>
                                                        <span class="text-xs text-gray-500" x-text="formatTime(n.date)"></span>
                                                    </div>
                                                    <p class="text-sm text-gray-400 truncate" x-text="n.subject"></p>
                                                </a>
                                            </template>
                                            <!-- Calendar reminder notification -->
                                            <template x-if="n.type === 'calendar'">
                                                <a href="/calendar"
                                                   class="block px-4 py-3 hover:bg-gray-700 border-b border-gray-700/50 bg-purple-900/20">
                                                    <div class="flex items-start gap-2">
                                                        <span class="text-lg">üìÖ</span>
                                                        <div class="flex-1 min-w-0">
                                                            <p class="text-sm font-medium text-white truncate" x-text="n.summary"></p>
                                                            <p class="text-xs text-purple-300" x-text="formatTime(n.start)"></p>
                                                            <p class="text-xs text-gray-500 truncate" x-show="n.location" x-text="n.location"></p>
                                                        </div>
                                                    </div>
                                                </a>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <button @click="toggleTheme()" 
                                class="p-2 rounded-md text-gray-400 hover:bg-gray-800" :class="{ 'hover:bg-gray-100': !darkMode, 'hover:bg-gray-800': darkMode }">
                            <span x-show="!darkMode">üåô</span>
                            <span x-show="darkMode" x-cloak>‚òÄÔ∏è</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div id="service-health-banner" 
             x-data="{ services: null, checking: false }"
             x-init="
                setInterval(async () => {
                    if (checking) return;
                    checking = true;
                    try {
                        const res = await fetch('/api/health/services');
                        const data = await res.json();
                        services = data;
                    } catch (e) {
                        services = { status: 'error', services: { engine: { status: 'down', error: e.message } } };
                    } finally {
                        checking = false;
                    }
                }, 30000);
             "
             x-show="services && services.status !== 'healthy'"
             x-cloak
             class="bg-yellow-900/90 border-b border-yellow-700 text-yellow-100 px-4 py-2 text-sm">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span>‚ö†Ô∏è</span>
                    <span>Some services are unavailable. Calendar and contacts features may not work.</span>
                </div>
                <button @click="services = null" class="text-yellow-200 hover:text-white">&times;</button>
            </div>
        </div>

        <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            {% block content %}{% endblock %}
        </main>
    </div>

    <div id="loading" class="htmx-indicator fixed top-0 left-0 right-0 h-1 bg-primary animate-pulse"></div>
    
    <div id="global-error-banner" x-data="{ show: false, message: '' }"
         x-show="show"
         x-cloak
         @show-error.window="show = true; message = $event.detail.message; setTimeout(() => show = false, 8000)"
         class="fixed top-0 left-0 right-0 z-[100] bg-red-800 border-b border-red-600 text-white text-center p-2 flex items-center justify-center">
        <span x-text="message"></span>
        <button @click="show = false" class="ml-4 text-xl leading-none hover:opacity-70">&times;</button>
    </div>

    <div id="toast-container" class="fixed bottom-4 right-4 z-[90] space-y-2"></div>
    
    <script src="/static/js/app.js"></script>
    <script>
        // Consolidated Toast Notification System
        window.showToast = function({ message, type = 'info', duration = 5000, onUndo = null }) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            const toastId = 'toast-' + Date.now();
            toast.id = toastId;

            const colors = {
                success: 'bg-green-900 border-green-700 text-green-200',
                error: 'bg-red-900 border-red-700 text-red-200',
                info: 'bg-blue-900 border-blue-700 text-blue-200',
                warning: 'bg-yellow-900 border-yellow-700 text-yellow-200'
            };

            toast.className = `${colors[type]} border rounded-lg px-4 py-3 shadow-lg flex items-center gap-3 min-w-[300px] max-w-md transform transition-all duration-300 translate-x-full`;
            
            let undoButton = '';
            if (onUndo) {
                undoButton = `<button class="px-2 py-1 text-sm bg-white/20 hover:bg-white/30 rounded font-semibold">Undo</button>`;
            }

            toast.innerHTML = `
                <span class="flex-1">${message}</span>
                ${undoButton}
                <button class="text-xl leading-none hover:opacity-70">&times;</button>
            `;

            container.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full');
            });

            const closeButton = toast.querySelector('button:last-of-type');
            const removeToast = () => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            };
            closeButton.onclick = removeToast;

            let timeoutId = null;
            if (duration > 0) {
                timeoutId = setTimeout(removeToast, duration);
            }

            if (onUndo) {
                const undoBtn = toast.querySelector('button:first-of-type');
                undoBtn.onclick = () => {
                    clearTimeout(timeoutId); // Stop the auto-dismiss
                    onUndo();
                    // The onUndo function is now responsible for showing any confirmation toast
                    removeToast();
                };
            }
        };

        // Global Error Handling
        window.addEventListener('unhandledrejection', function (event) {
            console.error('Unhandled Promise Rejection:', event.reason);
            const message = event.reason?.message || 'An unexpected error occurred.';
            window.dispatchEvent(new CustomEvent('show-error', { detail: { message: `System Error: ${message}` } }));
        });

        // HTMX Event Listeners
        document.body.addEventListener('htmx:responseError', function(event) {
            const errorDetail = event.detail.xhr;
            let message = 'Action failed. Please try again.';
            if (errorDetail.status === 0) {
                message = 'Network error. Could not connect to the server.';
                window.dispatchEvent(new CustomEvent('show-error', { detail: { message } }));
            } else {
                 try {
                    const response = JSON.parse(errorDetail.responseText);
                    message = response.detail || response.message || message;
                } catch (e) { /* Ignore if not JSON */ }
                showToast({ message, type: 'error' });
            }
        });

        document.body.addEventListener('htmx:afterRequest', function(event) {
            const xhr = event.detail.xhr;
            if (xhr && xhr.status >= 200 && xhr.status < 300) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    
                    // Standard success message
                    if (response.message) {
                        showToast({ message: response.message, type: response.success ? 'success' : 'info' });
                    }
                    
                    // Special handling for undoable actions
                    if (response.undo_action) {
                        showToast({
                            message: response.undo_message || 'Action completed.',
                            type: 'info',
                            duration: 7000, // Longer duration for undo
                            onUndo: () => {
                                htmx.ajax('POST', response.undo_action.url, {
                                    target: response.undo_action.target,
                                    swap: response.undo_action.swap || 'outerHTML'
                                }).then(() => {
                                    showToast({ message: 'Action undone', type: 'success' });
                                });
                            }
                        });
                    }

                } catch (e) { /* Not JSON, ignore */ }
            }
        });
        
        function notificationBell() {
            return {
                showPanel: false,
                notifications: [],
                unreadCount: 0,
                notificationsEnabled: false,
                checkInterval: null,
                
                init() {
                    this.notificationsEnabled = Notification.permission === 'granted';
                    this.checkForNew();
                    this.checkInterval = setInterval(() => this.checkForNew(), 30000);
                },
                
                togglePanel() {
                    this.showPanel = !this.showPanel;
                },
                
                async requestPermission() {
                    const permission = await Notification.requestPermission();
                    this.notificationsEnabled = permission === 'granted';
                    if (this.notificationsEnabled) {
                        window.showToast({ message: 'Desktop notifications enabled', type: 'success' });
                    }
                },
                
                async checkForNew() {
                    try {
                        const response = await fetch('/api/notifications/check');
                        const data = await response.json();

                        // Process new emails
                        if (data.new_emails && data.new_emails.length > 0) {
                            this.notifications = [
                                ...data.new_emails.map(e => ({ ...e, type: 'email' })),
                                ...this.notifications
                            ].slice(0, 20);
                            this.unreadCount = data.count;

                            if (this.notificationsEnabled && data.new_emails.length > 0) {
                                const email = data.new_emails[0];
                                new Notification('New Email', {
                                    body: `${email.from}: ${email.subject}`,
                                    icon: '/static/icon.png',
                                    tag: 'email-' + email.uid
                                });
                            }
                        }

                        // Process calendar reminders
                        if (data.calendar_reminders && data.calendar_reminders.length > 0) {
                            const reminders = data.calendar_reminders.map(r => ({
                                type: 'calendar',
                                id: r.id,
                                summary: r.summary,
                                start: r.start,
                                location: r.location
                            }));

                            this.notifications = [...reminders, ...this.notifications].slice(0, 20);
                            this.unreadCount = data.count;

                            if (this.notificationsEnabled) {
                                reminders.forEach(r => {
                                    new Notification('Upcoming Event', {
                                        body: `${r.summary}${r.location ? ' - ' + r.location : ''}`,
                                        icon: '/static/icon.png',
                                        tag: 'calendar-' + r.id
                                    });
                                });
                            }
                        }
                    } catch (e) {
                        console.error('Failed to check notifications:', e);
                    }
                },
                
                formatTime(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    const now = new Date();
                    const diff = now - date;
                    
                    if (diff < 60000) return 'Just now';
                    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
                    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
                    return date.toLocaleDateString();
                }
            };
        }
    </script>
</body>
</html>
