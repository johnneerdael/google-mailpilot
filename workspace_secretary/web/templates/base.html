<!DOCTYPE html>
<html lang="en" class="h-full {% if theme == 'dark' or (theme == 'system' and not theme) %}dark{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Secretary{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/theme.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script src="https://unpkg.com/@alpinejs/collapse@3.13.3/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <meta name="csrf-token" content="{{ csrf_token or '' }}">
    <script>
        document.addEventListener('htmx:configRequest', (event) => {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
            if (csrfToken) {
                event.detail.headers['X-CSRF-Token'] = csrfToken;
            }
        });
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        // Semantic tokens
                        canvas: 'var(--color-canvas)',
                        surface: 'var(--color-surface)',
                        'surface-subtle': 'var(--color-surface-subtle)',
                        body: 'var(--color-body)',
                        muted: 'var(--color-muted)',
                        border: 'var(--color-border)',
                        // Status colors
                        success: '#22c55e', // green-500
                        warning: '#eab308', // yellow-500
                        error: '#ef4444',   // red-500
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            [x-cloak] { display: none !important; }
        }
    </style>

</head>
<body class="h-full" style="background-color: var(--color-canvas); color: var(--color-body);" x-data="{ 
    darkMode: {% if theme == 'system' %}window.matchMedia('(prefers-color-scheme: dark)').matches{% elif theme == 'dark' %}true{% else %}false{% endif %},
    async toggleTheme() {
        this.darkMode = !this.darkMode;
        if(this.darkMode) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        try {
            const csrfToken = document.querySelector('meta[name=csrf-token]')?.content;
            await fetch('/api/settings/ui', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify({
                    theme: this.darkMode ? 'dark' : 'light',
                    density: '{{ density }}'
                })
            });
        } catch (e) {
            console.error('Failed to save theme preference:', e);
        }
    }
}" x-init="if(!darkMode) document.documentElement.classList.remove('dark'); else document.documentElement.classList.add('dark')">
    <div class="min-h-full">
        <nav style="background-color: var(--color-surface); border-bottom: 1px solid var(--color-border);" x-data="{ mobileMenuOpen: false }">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex items-center sm:hidden mr-2">
                            <button @click="mobileMenuOpen = !mobileMenuOpen" type="button" 
                                    class="btn-icon">
                                <span class="sr-only">Open main menu</span>
                                <svg x-show="!mobileMenuOpen" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                                <svg x-show="mobileMenuOpen" x-cloak class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="flex-shrink-0 flex items-center">
                            <a href="/inbox" class="text-xl font-bold">
                                üìß Secretary
                            </a>
                        </div>
                        <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                            <a href="/inbox" class="nav-link active border-b-2" style="border-color: var(--color-primary);">
                                Inbox
                            </a>
                            <a href="/calendar" class="nav-link border-b-2 border-transparent">
                                Calendar
                            </a>
                            <a href="/contacts" class="nav-link border-b-2 border-transparent">
                                Contacts
                            </a>
                            <a href="/chat" class="nav-link border-b-2 border-transparent">
                                ü§ñ Assistant
                            </a>
                            <a href="/tasks" class="nav-link border-b-2 border-transparent">
                                ‚úì Tasks
                            </a>
                            <a href="/search" class="nav-link border-b-2 border-transparent">
                                Search
                            </a>
                            <a href="/settings" class="nav-link border-b-2 border-transparent">
                                ‚öôÔ∏è Settings
                            </a>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div x-data="notificationBell()" x-init="init()">
                            <button @click="togglePanel()" class="btn-icon relative">
                                <span>üîî</span>
                                <span x-show="unreadCount > 0" x-cloak 
                                      style="position: absolute; top: -0.25rem; right: -0.25rem; width: 1.25rem; height: 1.25rem; background-color: var(--color-error); color: white; font-size: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center;"
                                      x-text="unreadCount > 9 ? '9+' : unreadCount"></span>
                            </button>
                            
                            <div x-show="showPanel" x-cloak @click.outside="showPanel = false"
                                 style="position: absolute; right: 1rem; margin-top: 0.5rem; width: 20rem; background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 0.5rem; box-shadow: var(--shadow-lg); z-index: 50;">
                                <div style="padding: 0.75rem; border-bottom: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between;">
                                    <h3 style="font-weight: 500; color: var(--color-body);">Notifications</h3>
                                    <button @click="requestPermission()" x-show="!notificationsEnabled && notificationsSupported" 
                                            style="font-size: 0.75rem; color: var(--color-primary);">
                                        Enable desktop notifications
                                    </button>
                                    <span x-show="!notificationsSupported" 
                                          style="font-size: 0.75rem; color: var(--color-muted);">
                                        Notifications not supported
                                    </span>
                                </div>
                                <div style="max-height: 24rem; overflow-y: auto;">
                                    <template x-if="notifications.length === 0">
                                        <div style="padding: 1rem; text-align: center; color: var(--color-muted); font-size: 0.875rem;">
                                            No new notifications
                                        </div>
                                    </template>
                                    <template x-for="n in notifications" :key="n.uid || n.id">
                                        <div>
                                            <template x-if="n.type === 'email'">
                                                <a :href="'/thread/' + n.folder + '/' + n.uid"
                                                   style="display: block; padding: 0.75rem 1rem; border-bottom: 1px solid var(--color-border);"
                                                   @mouseenter="$el.style.backgroundColor = 'var(--color-surface-hover)'"
                                                   @mouseleave="$el.style.backgroundColor = ''">
                                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.25rem;">
                                                        <span style="font-size: 0.875rem; font-weight: 500; color: var(--color-body); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="n.from"></span>
                                                        <span style="font-size: 0.75rem; color: var(--color-muted);" x-text="formatTime(n.date)"></span>
                                                    </div>
                                                    <p style="font-size: 0.875rem; color: var(--color-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="n.subject"></p>
                                                </a>
                                            </template>
                                            <template x-if="n.type === 'calendar'">
                                                <a href="/calendar"
                                                   style="display: block; padding: 0.75rem 1rem; border-bottom: 1px solid var(--color-border); background-color: rgba(147, 51, 234, 0.1);"
                                                   @mouseenter="$el.style.backgroundColor = 'rgba(147, 51, 234, 0.2)'"
                                                   @mouseleave="$el.style.backgroundColor = 'rgba(147, 51, 234, 0.1)'">
                                                    <div style="display: flex; align-items: start; gap: 0.5rem;">
                                                        <span style="font-size: 1.125rem;">üìÖ</span>
                                                        <div style="flex: 1; min-width: 0;">
                                                            <p style="font-size: 0.875rem; font-weight: 500; color: var(--color-body); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="n.summary"></p>
                                                            <p style="font-size: 0.75rem; color: #a78bfa;" x-text="formatTime(n.start)"></p>
                                                            <p style="font-size: 0.75rem; color: var(--color-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-show="n.location" x-text="n.location"></p>
                                                        </div>
                                                    </div>
                                                </a>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <button @click="toggleTheme()" 
                                class="btn-icon">
                            <span x-show="!darkMode">üåô</span>
                            <span x-show="darkMode" x-cloak>‚òÄÔ∏è</span>
                        </button>
                    </div>
                </div>
            </div>

            <div x-show="mobileMenuOpen" x-cloak style="border-top: 1px solid var(--color-border);" id="mobile-menu" class="sm:hidden">
                <div class="pt-2 pb-3 space-y-1">
                    <a href="/inbox" style="display: block; padding: 0.5rem 1rem; padding-left: 0.75rem; border-left: 4px solid var(--color-primary); font-size: 1rem; font-weight: 500; color: var(--color-primary); background-color: var(--color-primary-subtle);">
                        Inbox
                    </a>
                    <a href="/calendar" class="nav-link" style="display: block; padding: 0.5rem 1rem; padding-left: 0.75rem; border-left: 4px solid transparent; font-size: 1rem; font-weight: 500;">
                        Calendar
                    </a>
                    <a href="/contacts" class="nav-link" style="display: block; padding: 0.5rem 1rem; padding-left: 0.75rem; border-left: 4px solid transparent; font-size: 1rem; font-weight: 500;">
                        Contacts
                    </a>
                    <a href="/chat" class="nav-link" style="display: block; padding: 0.5rem 1rem; padding-left: 0.75rem; border-left: 4px solid transparent; font-size: 1rem; font-weight: 500;">
                        ü§ñ Assistant
                    </a>
                    <a href="/tasks" class="nav-link" style="display: block; padding: 0.5rem 1rem; padding-left: 0.75rem; border-left: 4px solid transparent; font-size: 1rem; font-weight: 500;">
                        ‚úì Tasks
                    </a>
                    <a href="/search" class="nav-link" style="display: block; padding: 0.5rem 1rem; padding-left: 0.75rem; border-left: 4px solid transparent; font-size: 1rem; font-weight: 500;">
                        Search
                    </a>
                    <a href="/settings" class="nav-link" style="display: block; padding: 0.5rem 1rem; padding-left: 0.75rem; border-left: 4px solid transparent; font-size: 1rem; font-weight: 500;">
                        ‚öôÔ∏è Settings
                    </a>
                </div>
            </div>
        </nav>

        <div id="service-health-banner" 
             x-data="{ services: null, checking: false }"
             x-init="
                setInterval(async () => {
                    if (checking) return;
                    checking = true;
                    try {
                        const res = await fetch('/api/health/services');
                        const data = await res.json();
                        services = data;
                    } catch (e) {
                        services = { status: 'error', services: { engine: { status: 'down', error: e.message } } };
                    } finally {
                        checking = false;
                    }
                }, 30000);
             "
             x-show="services && services.status !== 'healthy'"
             x-cloak
             class="bg-yellow-900/90 border-b border-yellow-700 text-yellow-100 px-4 py-2 text-sm">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span>‚ö†Ô∏è</span>
                    <span>Some services are unavailable. Calendar and contacts features may not work.</span>
                </div>
                <button @click="services = null" class="text-yellow-200 hover:text-white">&times;</button>
            </div>
        </div>

        <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            {% block content %}{% endblock %}
        </main>
    </div>

    <div id="loading" class="htmx-indicator fixed top-0 left-0 right-0 h-1 bg-primary animate-pulse"></div>
    
    <div id="global-error-banner" x-data="{ show: false, message: '' }"
         x-show="show"
         x-cloak
         @show-error.window="show = true; message = $event.detail.message; setTimeout(() => show = false, 8000)"
         class="fixed top-0 left-0 right-0 z-[100] bg-red-800 border-b border-red-600 text-white text-center p-2 flex items-center justify-center">
        <span x-text="message"></span>
        <button @click="show = false" class="ml-4 text-xl leading-none hover:opacity-70">&times;</button>
    </div>

    <div id="toast-container" class="fixed bottom-4 right-4 z-[90] space-y-2"></div>
    
    <script src="/static/js/app.js"></script>
    <script>
        // Consolidated Toast Notification System
        window.showToast = function({ message, type = 'info', duration = 5000, onUndo = null }) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            const toastId = 'toast-' + Date.now();
            toast.id = toastId;

            const colors = {
                success: 'bg-green-900 border-green-700 text-green-200',
                error: 'bg-red-900 border-red-700 text-red-200',
                info: 'bg-blue-900 border-blue-700 text-blue-200',
                warning: 'bg-yellow-900 border-yellow-700 text-yellow-200'
            };

            toast.className = `${colors[type]} border rounded-lg px-4 py-3 shadow-lg flex items-center gap-3 min-w-[300px] max-w-md transform transition-all duration-300 translate-x-full`;
            
            let undoButton = '';
            if (onUndo) {
                undoButton = `<button class="px-2 py-1 text-sm bg-white/20 hover:bg-white/30 rounded font-semibold">Undo</button>`;
            }

            toast.innerHTML = `
                <span class="flex-1">${message}</span>
                ${undoButton}
                <button class="text-xl leading-none hover:opacity-70">&times;</button>
            `;

            container.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full');
            });

            const closeButton = toast.querySelector('button:last-of-type');
            const removeToast = () => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            };
            closeButton.onclick = removeToast;

            let timeoutId = null;
            if (duration > 0) {
                timeoutId = setTimeout(removeToast, duration);
            }

            if (onUndo) {
                const undoBtn = toast.querySelector('button:first-of-type');
                undoBtn.onclick = () => {
                    clearTimeout(timeoutId); // Stop the auto-dismiss
                    onUndo();
                    // The onUndo function is now responsible for showing any confirmation toast
                    removeToast();
                };
            }
        };

        // Global Error Handling
        window.addEventListener('unhandledrejection', function (event) {
            console.error('Unhandled Promise Rejection:', event.reason);
            const message = event.reason?.message || 'An unexpected error occurred.';
            window.dispatchEvent(new CustomEvent('show-error', { detail: { message: `System Error: ${message}` } }));
        });

        // HTMX Event Listeners
        document.body.addEventListener('htmx:responseError', function(event) {
            const errorDetail = event.detail.xhr;
            let message = 'Action failed. Please try again.';
            if (errorDetail.status === 0) {
                message = 'Network error. Could not connect to the server.';
                window.dispatchEvent(new CustomEvent('show-error', { detail: { message } }));
            } else {
                 try {
                    const response = JSON.parse(errorDetail.responseText);
                    message = response.detail || response.message || message;
                } catch (e) { /* Ignore if not JSON */ }
                showToast({ message, type: 'error' });
            }
        });

        document.body.addEventListener('htmx:afterRequest', function(event) {
            const xhr = event.detail.xhr;
            if (xhr && xhr.status >= 200 && xhr.status < 300) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    
                    // Standard success message
                    if (response.message) {
                        showToast({ message: response.message, type: response.success ? 'success' : 'info' });
                    }
                    
                    // Special handling for undoable actions
                    if (response.undo_action) {
                        showToast({
                            message: response.undo_message || 'Action completed.',
                            type: 'info',
                            duration: 7000, // Longer duration for undo
                            onUndo: () => {
                                htmx.ajax('POST', response.undo_action.url, {
                                    target: response.undo_action.target,
                                    swap: response.undo_action.swap || 'outerHTML'
                                }).then(() => {
                                    showToast({ message: 'Action undone', type: 'success' });
                                });
                            }
                        });
                    }

                } catch (e) { /* Not JSON, ignore */ }
            }
        });
        
        function notificationBell() {
            return {
                showPanel: false,
                notifications: [],
                unreadCount: 0,
                notificationsEnabled: false,
                notificationsSupported: false,
                checkInterval: null,
                
                init() {
                    this.notificationsSupported = 'Notification' in window;
                    if (this.notificationsSupported) {
                        this.notificationsEnabled = Notification.permission === 'granted';
                    }
                    this.checkForNew();
                    this.checkInterval = setInterval(() => this.checkForNew(), 30000);
                },
                
                togglePanel() {
                    this.showPanel = !this.showPanel;
                },
                
                async requestPermission() {
                    if (!this.notificationsSupported) {
                        window.showToast({ message: 'Desktop notifications are not supported in this browser', type: 'error' });
                        return;
                    }
                    try {
                        const permission = await Notification.requestPermission();
                        this.notificationsEnabled = permission === 'granted';
                        if (this.notificationsEnabled) {
                            window.showToast({ message: 'Desktop notifications enabled', type: 'success' });
                        } else if (permission === 'denied') {
                            window.showToast({ message: 'Notifications were blocked. Please enable them in browser settings.', type: 'error' });
                        }
                    } catch (e) {
                        console.error('Failed to request notification permission:', e);
                        window.showToast({ message: 'Failed to enable notifications', type: 'error' });
                    }
                },
                
                async checkForNew() {
                    try {
                        const response = await fetch('/api/notifications/check');
                        const data = await response.json();

                        // Process new emails
                        if (data.new_emails && data.new_emails.length > 0) {
                            this.notifications = [
                                ...data.new_emails.map(e => ({ ...e, type: 'email' })),
                                ...this.notifications
                            ].slice(0, 20);
                            this.unreadCount = data.count;

                            if (this.notificationsEnabled && data.new_emails.length > 0) {
                                const email = data.new_emails[0];
                                new Notification('New Email', {
                                    body: `${email.from}: ${email.subject}`,
                                    icon: '/static/icon.png',
                                    tag: 'email-' + email.uid
                                });
                            }
                        }

                        // Process calendar reminders
                        if (data.calendar_reminders && data.calendar_reminders.length > 0) {
                            const reminders = data.calendar_reminders.map(r => ({
                                type: 'calendar',
                                id: r.id,
                                summary: r.summary,
                                start: r.start,
                                location: r.location
                            }));

                            this.notifications = [...reminders, ...this.notifications].slice(0, 20);
                            this.unreadCount = data.count;

                            if (this.notificationsEnabled) {
                                reminders.forEach(r => {
                                    new Notification('Upcoming Event', {
                                        body: `${r.summary}${r.location ? ' - ' + r.location : ''}`,
                                        icon: '/static/icon.png',
                                        tag: 'calendar-' + r.id
                                    });
                                });
                            }
                        }
                    } catch (e) {
                        console.error('Failed to check notifications:', e);
                    }
                },
                
                formatTime(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    const now = new Date();
                    const diff = now - date;
                    
                    if (diff < 60000) return 'Just now';
                    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
                    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
                    return date.toLocaleDateString();
                }
            };
        }
    </script>
</body>
</html>
