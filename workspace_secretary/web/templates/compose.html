<div class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" 
     x-data="{ 
         sending: false,
         lastSaved: null,
         autoSaveTimer: null,
         attachments: [],
         isDragging: false,
         uploadProgress: 0,
         showValidation: false,
         validationErrors: [],
         scheduleDateTime: null,
         handleDrop(event) {
             this.isDragging = false;
             const files = Array.from(event.dataTransfer.files);
             this.attachments.push(...files);
         },
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            },
            isSuspiciousFile(filename) {
                const suspiciousExts = ['.exe', '.bat', '.cmd', '.com', '.scr', '.vbs', '.js', '.jar', '.dll', '.msi', '.app', '.dmg', '.sh', '.ps1'];
                return suspiciousExts.some(ext => filename.toLowerCase().endsWith(ext));
            }
     }"
     x-init="
         autoSaveTimer = setInterval(() => {
             if ({{ 'true' if reply_to_uid else 'false' }}) {
                 const form = $el.querySelector('form');
                 const formData = new FormData(form);
                 fetch('/api/email/draft', {
                     method: 'POST',
                     body: formData
                 }).then(() => {
                     lastSaved = new Date();
                 });
             }
         }, 30000);
     "
     x-effect="() => { if ($el.dataset.cleanup !== 'done') { return () => { clearInterval(autoSaveTimer); $el.dataset.cleanup = 'done'; }; } }"
     @keydown.escape.window="$el.remove()">
    <div class="bg-surface rounded-xl shadow-2xl border border-border w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="flex items-center justify-between px-6 py-4 border-b border-border bg-surface rounded-t-xl">
            <h2 class="h2">
                {% if mode == 'new' %}New Message
                {% elif mode == 'reply' %}Reply
                {% elif mode == 'reply_all' %}Reply All
                {% elif mode == 'forward' %}Forward
                {% endif %}
            </h2>
            <button @click="$el.closest('.fixed').remove()" 
                    class="text-muted hover:text-body p-1 rounded-md hover:bg-surface-subtle">
                ‚úï
            </button>
        </div>
        
        <form hx-post="/api/email/send" 
              hx-swap="none"
              hx-on::before-request="sending = true"
              hx-on::after-request="if(event.detail.successful) { $el.closest('.fixed').remove(); window.showToast('Email sent!', 'success'); } else { sending = false; window.showToast('Failed to send', 'error'); }"
              class="flex flex-col flex-1 overflow-hidden">
            
            {% if original_message_id %}
            <input type="hidden" name="reply_to_message_id" value="{{ original_message_id }}">
            {% endif %}
            
            <div class="px-6 py-2 space-y-2 border-b border-border">
                <div class="flex items-center py-1">
                    <label class="w-20 text-sm font-medium text-muted">From:</label>
                    <select name="from_alias" 
                            class="flex-1 bg-transparent text-body text-sm focus:outline-none py-1">
                        <option value="default">Primary Account</option>
                    </select>
                </div>
                <div class="flex items-center relative py-1" x-data="{ suggestions: [], showSuggestions: false }">
                    <label class="w-20 text-sm font-medium text-muted">To:</label>
                    <input type="email" name="to" value="{{ to }}" required
                           @input="
                               if ($event.target.value.length > 2) {
                                   fetch('/api/contacts/autocomplete?q=' + encodeURIComponent($event.target.value))
                                       .then(r => r.json())
                                       .then(data => { suggestions = data.contacts; showSuggestions = true; });
                               } else {
                                   showSuggestions = false;
                               }
                           "
                           @blur="setTimeout(() => showSuggestions = false, 200)"
                           class="flex-1 bg-transparent text-body text-sm focus:outline-none placeholder-muted/50 py-1"
                           placeholder="recipient@example.com">
                    <div x-show="showSuggestions && suggestions.length > 0" 
                         class="absolute top-full left-20 mt-1 bg-surface border border-border rounded shadow-lg z-10 w-64">
                        <template x-for="contact in suggestions" :key="contact">
                            <button type="button" 
                                    @click="$el.closest('.relative').querySelector('input').value = contact; showSuggestions = false"
                                    class="w-full text-left px-3 py-2 text-sm text-body hover:bg-surface-hover"
                                    x-text="contact"></button>
                        </template>
                    </div>
                </div>
                <div class="flex items-center py-1">
                    <label class="w-20 text-sm font-medium text-muted">Cc:</label>
                    <input type="text" name="cc" value="{{ cc }}"
                           class="flex-1 bg-transparent text-body text-sm focus:outline-none placeholder-muted/50 py-1"
                           placeholder="cc@example.com">
                </div>
                <div class="flex items-center py-1" x-data="{ showBcc: false }">
                    <template x-if="!showBcc">
                        <button type="button" @click="showBcc = true" 
                                class="text-sm text-muted hover:text-body">
                            + Bcc
                        </button>
                    </template>
                    <template x-if="showBcc">
                        <div class="flex items-center w-full">
                            <label class="w-20 text-sm font-medium text-muted">Bcc:</label>
                            <input type="text" name="bcc" value="{{ bcc }}"
                                   class="flex-1 bg-transparent text-body text-sm focus:outline-none placeholder-muted/50 py-1"
                                   placeholder="bcc@example.com">
                        </div>
                    </template>
                </div>
                <div class="flex items-center py-1">
                    <label class="w-20 text-sm font-medium text-muted">Subject:</label>
                    <input type="text" name="subject" value="{{ subject }}" required
                           class="flex-1 bg-transparent text-body text-sm font-medium focus:outline-none placeholder-muted/50 py-1"
                           placeholder="Subject">
                </div>
            </div>
            
            <div class="flex-1 overflow-auto p-6" x-data="{ richText: false }"
                 @drop.prevent="handleDrop($event)"
                 @dragover.prevent="isDragging = true"
                 @dragleave="isDragging = false">
                <div class="flex items-center justify-end mb-2">
                    <button type="button" 
                            @click="richText = !richText"
                            class="text-xs text-muted hover:text-body">
                        <span x-show="!richText">üìù Enable Rich Text</span>
                        <span x-show="richText">üìÑ Plain Text</span>
                    </button>
                </div>
                <div x-show="richText" class="mb-2 flex gap-1 border-b border-border pb-2 flex-wrap">
                    <button type="button" onclick="document.execCommand('bold')" class="px-2 py-1 text-xs bg-surface-subtle hover:bg-surface-hover text-body rounded" title="Bold">B</button>
                    <button type="button" onclick="document.execCommand('italic')" class="px-2 py-1 text-xs bg-surface-subtle hover:bg-surface-hover text-body rounded italic" title="Italic">I</button>
                    <button type="button" onclick="document.execCommand('underline')" class="px-2 py-1 text-xs bg-surface-subtle hover:bg-surface-hover text-body rounded underline" title="Underline">U</button>
                    <button type="button" onclick="document.execCommand('insertUnorderedList')" class="px-2 py-1 text-xs bg-surface-subtle hover:bg-surface-hover text-body rounded" title="Bullet List">‚Ä¢</button>
                    <button type="button" onclick="document.execCommand('insertOrderedList')" class="px-2 py-1 text-xs bg-surface-subtle hover:bg-surface-hover text-body rounded" title="Numbered List">1.</button>
                    <button type="button" onclick="document.execCommand('createLink', false, prompt('Enter URL:'))" class="px-2 py-1 text-xs bg-surface-subtle hover:bg-surface-hover text-body rounded" title="Link">üîó</button>
                </div>
                
                <div class="relative min-h-[300px]">
                    <textarea name="body" x-show="!richText"
                              class="w-full h-full min-h-[300px] bg-transparent text-body text-sm focus:outline-none resize-none placeholder-muted/50"
                              :class="{'ring-2 ring-primary rounded': isDragging}"
                              placeholder="Write your message...">{{ body }}</textarea>
                    <div x-show="richText" 
                         contenteditable="true"
                         class="w-full h-full min-h-[300px] bg-transparent text-body text-sm focus:outline-none overflow-auto prose prose-invert max-w-none"
                         @input="$el.closest('.relative').querySelector('textarea').value = $el.innerHTML">{{ body }}</div>
                    <div x-show="isDragging" 
                         class="absolute inset-0 flex items-center justify-center bg-primary/10 border-2 border-dashed border-primary rounded-md pointer-events-none z-10">
                        <p class="text-primary font-medium text-lg">Drop files here</p>
                    </div>
                </div>
                
                <div x-show="attachments.length > 0" class="mt-4 space-y-2">
                    <p class="text-xs font-medium text-muted">Attachments:</p>
                    <template x-for="(file, index) in attachments" :key="index">
                        <div class="flex items-center justify-between p-2 rounded-md border"
                             :class="isSuspiciousFile(file.name) ? 'bg-red-900/30 border-red-700' : 'bg-surface-subtle border-border'">
                            <div class="flex items-center gap-2 min-w-0 flex-1">
                                <span x-show="isSuspiciousFile(file.name)" class="text-red-400 text-lg" title="Warning: Potentially dangerous file type">‚ö†Ô∏è</span>
                                <span x-show="!isSuspiciousFile(file.name)" class="text-muted text-lg">üìé</span>
                                <div class="min-w-0">
                                    <p class="text-sm truncate" 
                                       :class="isSuspiciousFile(file.name) ? 'text-red-300' : 'text-body'" 
                                       x-text="file.name"></p>
                                    <p class="text-xs text-muted" x-text="formatFileSize(file.size)"></p>
                                </div>
                            </div>
                            <button type="button" 
                                    @click="attachments.splice(index, 1)"
                                    class="text-muted hover:text-red-500 ml-2"
                                    title="Remove attachment">
                                <span class="text-xl">√ó</span>
                            </button>
                        </div>
                    </template>
                </div>
            </div>
            
            <div class="flex items-center justify-between px-6 py-4 border-t border-border bg-surface rounded-b-xl">
                <div class="flex items-center space-x-2">
                    <button type="button" 
                            @click="$refs.fileInput.click()"
                            class="btn-icon"
                            title="Attach file">
                        üìé
                    </button>
                    <input type="file" x-ref="fileInput" multiple class="hidden"
                           @change="attachments = Array.from($event.target.files)">
                    <span x-show="attachments.length > 0" class="text-xs text-muted" x-text="attachments.length + ' file(s)'"></span>
                    
                    <button type="button" 
                            @click="$refs.scheduleInput.showPicker()"
                            class="btn-icon"
                            title="Schedule send">
                        ‚è∞
                    </button>
                    <input type="datetime-local" x-ref="scheduleInput" name="schedule_time" 
                           class="absolute opacity-0 pointer-events-none"
                           @change="scheduleDateTime = $event.target.value">
                    <span x-show="scheduleDateTime" class="text-xs text-muted">
                        Scheduled <span x-text="new Date(scheduleDateTime).toLocaleString()"></span>
                    </span>
                    
                    <span x-show="lastSaved" class="text-xs text-muted ml-2">
                        Saved <span x-text="Math.floor((Date.now() - lastSaved) / 1000)"></span>s ago
                    </span>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="button" 
                            @click="$el.closest('.fixed').remove()"
                            class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" 
                            :disabled="sending"
                            @click.prevent="
                                validationErrors = [];
                                const form = $el.closest('form');
                                const subject = form.querySelector('[name=subject]').value;
                                const body = form.querySelector('[name=body]').value;
                                const to = form.querySelector('[name=to]').value;
                                
                                if (!to) validationErrors.push('Recipient is required');
                                if (!subject) validationErrors.push('Subject is missing');
                                if (attachments.length === 0 && /attach/i.test(body)) {
                                    validationErrors.push('Did you forget to attach a file?');
                                }
                                
                                if (validationErrors.length > 0) {
                                    showValidation = true;
                                    setTimeout(() => { showValidation = false; validationErrors = []; }, 5000);
                                } else {
                                    sending = true;
                                    const formData = new FormData(form);
                                    fetch('/api/email/send', { method: 'POST', body: formData })
                                        .then(r => r.json())
                                        .then(data => {
                                            if (data.success) {
                                                $el.closest('.fixed').remove();
                                                window.showToast('Email will be sent in 5 seconds. Click to undo.', 'success', 5000, () => {
                                                    window.showToast('Send cancelled', 'info');
                                                });
                                            } else {
                                                sending = false;
                                                window.showToast('Failed to send: ' + data.error, 'error');
                                            }
                                        });
                                }
                            "
                            class="btn-primary flex items-center gap-2">
                        <span x-show="!sending">Send</span>
                        <span x-show="sending">Sending...</span>
                    </button>
                </div>
            </div>
            
            <div x-show="showValidation" 
                 x-transition
                 class="absolute top-4 right-4 bg-yellow-900 border border-yellow-700 text-yellow-200 px-4 py-2 rounded-md shadow-lg z-20">
                <ul class="text-sm">
                    <template x-for="error in validationErrors">
                        <li x-text="error"></li>
                    </template>
                </ul>
            </div>
        </form>
    </div>
</div>
