{% extends "base.html" %}
{% block title %}Inbox - Secretary{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-4 lg:gap-6" x-data="{ 
    ...bulkActions(),
    showTasks: false,
    showAddTask: false,
    newTask: { description: '', priority: 'medium', due_date: '' }
}" @open-add-task.window="showAddTask = true">
    <div class="flex-1 space-y-4 min-w-0">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <h1 class="h1">Inbox</h1>
            <div class="flex items-center justify-between sm:justify-end space-x-4">
                <label class="flex items-center space-x-2 text-sm text-muted">
                    <input type="checkbox" 
                           {% if unread_only %}checked{% endif %}
                           hx-get="/inbox?unread_only={{ 'false' if unread_only else 'true' }}&folder={{ folder }}"
                           hx-target="body"
                           hx-swap="outerHTML"
                           class="rounded bg-surface-subtle border-border text-primary focus:ring-primary">
                    <span>Unread only</span>
                </label>
                <button @click="showTasks = !showTasks"
                        class="btn-icon lg:hidden"
                        :class="{ 'bg-surface-subtle text-primary': showTasks }"
                        title="Toggle Tasks">
                    ‚úì
                </button>
                <a href="/compose" class="btn-primary no-underline touch-manipulation">
                    <span class="hidden sm:inline">‚úèÔ∏è Compose</span>
                    <span class="sm:hidden">‚úèÔ∏è</span>
                </a>
            </div>
        </div>

        <div x-show="selected.length > 0" x-cloak 
             class="flex flex-wrap items-center gap-2 p-3 bg-surface border border-border rounded-lg shadow-sm">
            <span class="text-sm text-muted" x-text="selected.length + ' selected'"></span>
            <div class="flex flex-wrap gap-2 ml-auto">
                <button @click="bulkAction('mark-read')" 
                        class="btn-secondary text-xs py-1.5 touch-manipulation">
                    ‚úì Mark Read
                </button>
                <button @click="bulkAction('mark-unread')" 
                        class="btn-secondary text-xs py-1.5 touch-manipulation">
                    ‚óã Mark Unread
                </button>
                <button @click="bulkAction('archive')" 
                        class="btn-secondary text-xs py-1.5 touch-manipulation">
                    üì• Archive
                </button>
                <button @click="bulkAction('delete')" 
                        class="px-3 py-1.5 text-xs font-medium text-white bg-error rounded hover:bg-red-600 touch-manipulation transition-colors">
                    üóëÔ∏è Delete
                </button>
                <button @click="clearSelection()" 
                        class="px-3 py-1.5 text-xs font-medium text-muted hover:text-body touch-manipulation">
                    ‚úï Clear
                </button>
            </div>
        </div>

        <div class="bg-surface rounded-lg divide-y divide-border border border-border shadow-sm"
             id="email-list-container"
             hx-get="/api/emails?page={{ page }}&folder={{ folder }}&unread_only={{ unread_only }}"
             hx-trigger="refreshList from:body"
             hx-target="#email-list-rows"
             hx-select="#email-list-rows">
            {% if emails %}
            <div class="px-3 py-2 sm:px-4 border-b border-border flex items-center gap-3">
                <label class="flex items-center cursor-pointer touch-manipulation">
                    <input type="checkbox" 
                           @change="toggleAll($event.target.checked)"
                           :checked="selected.length === {{ emails|length }}"
                           :indeterminate="selected.length > 0 && selected.length < {{ emails|length }}"
                           class="rounded bg-surface-subtle border-border text-primary focus:ring-primary">
                </label>
                <span class="text-xs text-muted">Select all</span>
            </div>
            <div id="email-list-rows">
                {% for email in emails %}
                <div class="flex items-start hover:bg-surface-subtle transition-colors">
                    <label class="flex items-center px-3 py-4 cursor-pointer touch-manipulation self-stretch">
                        <input type="checkbox" 
                               value="{{ email.uid }}"
                               data-folder="{{ email.folder }}"
                               @change="toggleSelect('{{ email.uid }}', '{{ email.folder }}', $event.target.checked)"
                               :checked="isSelected('{{ email.uid }}')"
                               class="rounded bg-surface-subtle border-border text-primary focus:ring-primary">
                    </label>
                    <button hx-post="/api/email/toggle-star/{{ email.folder }}/{{ email.uid }}"
                            hx-swap="none"
                            hx-on::after-request="this.querySelector('span').textContent = event.detail.xhr.response.includes('true') ? '‚òÖ' : '‚òÜ'; this.querySelector('span').classList.toggle('text-yellow-400', event.detail.xhr.response.includes('true'))"
                            class="flex items-center py-4 pr-1 touch-manipulation"
                            title="Toggle star">
                        <span class="text-lg {% if email.is_starred %}text-yellow-400{% else %}text-muted hover:text-body{% endif %}">
                            {% if email.is_starred %}‚òÖ{% else %}‚òÜ{% endif %}
                        </span>
                    </button>
                    <a href="/thread/{{ email.folder }}/{{ email.uid }}" 
                       class="flex-1 py-3 pr-3 sm:pr-4 touch-manipulation">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 sm:gap-0">
                            <div class="flex items-start sm:items-center min-w-0 flex-1">
                                {% if email.is_unread %}
                                <span class="w-2 h-2 bg-primary rounded-full mr-2 sm:mr-3 flex-shrink-0 mt-1.5 sm:mt-0"></span>
                                {% else %}
                                <span class="w-2 h-2 mr-2 sm:mr-3 flex-shrink-0"></span>
                                {% endif %}
                                
                                <div class="min-w-0 flex-1">
                                    <div class="flex items-center justify-between sm:justify-start gap-2">
                                        <p class="text-sm font-medium truncate {% if email.is_unread %}text-body{% else %}text-muted{% endif %}">
                                            {{ email.from_name or email.from_addr }}
                                        </p>
                                        <div class="flex items-center gap-1 sm:hidden flex-shrink-0">
                                            {% if email.has_attachments %}
                                            <span class="text-muted text-xs">üìé</span>
                                            {% endif %}
                                            <span class="text-xs text-muted">{{ email.date }}</span>
                                        </div>
                                    </div>
                                    
                                    <p class="text-sm truncate mt-0.5 {% if email.is_unread %}text-body font-semibold{% else %}text-muted{% endif %}">
                                        {{ email.subject }}
                                    </p>
                                    {% if email.preview %}
                                    <p class="text-xs sm:text-sm text-muted truncate mt-0.5 hidden sm:block">
                                        {{ email.preview }}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="hidden sm:flex ml-4 items-center space-x-2 flex-shrink-0">
                                {% if email.has_attachments %}
                                <span class="text-muted" title="Has attachments">üìé</span>
                                {% endif %}
                                <span class="text-sm text-muted">{{ email.date }}</span>
                            </div>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        {% else %}
            {% with icon="üì≠", title="No emails found", description="Try adjusting your filters." %}
                {% include "partials/empty_state.html" %}
            {% endwith %}
        {% endif %}
    </div>

    {% if has_more %}
    <div id="infinite-scroll-trigger"
         hx-get="/inbox/more?page={{ page + 1 }}&folder={{ folder }}&unread_only={{ unread_only }}"
         hx-trigger="revealed"
         hx-swap="afterend"
         hx-select="#more-emails-content"
         class="flex justify-center py-4">
        <span class="text-sm text-gray-500">Loading more...</span>
    </div>
    {% endif %}
    
    <noscript>
    {% if has_more or page > 1 %}
    <div class="flex justify-between items-center gap-2 mt-4">
        {% if page > 1 %}
        <a href="/inbox?page={{ page - 1 }}&folder={{ folder }}&unread_only={{ unread_only }}"
           class="px-3 sm:px-4 py-2 text-sm font-medium text-gray-300 bg-gray-900 border border-gray-700 rounded-md hover:bg-gray-800">
            ‚Üê Previous
        </a>
        {% else %}
        <div></div>
        {% endif %}
        
        <span class="text-sm text-gray-500">Page {{ page }}</span>
        
        {% if has_more %}
        <a href="/inbox?page={{ page + 1 }}&folder={{ folder }}&unread_only={{ unread_only }}"
           class="px-3 sm:px-4 py-2 text-sm font-medium text-gray-300 bg-gray-900 border border-gray-700 rounded-md hover:bg-gray-800">
            Next ‚Üí
        </a>
        {% else %}
        <div></div>
        {% endif %}
    </div>
    {% endif %}
    </noscript>
</div>

    <div class="hidden lg:block w-72 flex-shrink-0">
        <div class="card sticky top-4"
             hx-get="/api/tasks/sidebar"
             hx-trigger="load, refreshTasks from:body"
             hx-swap="innerHTML">
            <div class="animate-pulse space-y-3">
                <div class="h-4 bg-surface-subtle rounded w-1/3"></div>
                <div class="h-8 bg-surface-subtle rounded"></div>
                <div class="h-8 bg-surface-subtle rounded"></div>
                <div class="h-8 bg-surface-subtle rounded"></div>
            </div>
        </div>
    </div>
    
    <div x-show="showTasks" x-cloak 
         class="lg:hidden fixed inset-0 z-40 bg-black/50"
         @click="showTasks = false">
        <div class="absolute right-0 top-0 bottom-0 w-80 max-w-full bg-surface overflow-y-auto"
             @click.stop
             hx-get="/api/tasks/sidebar"
             hx-trigger="intersect once, refreshTasks from:body"
             hx-swap="innerHTML">
            <div class="p-4 border-b border-border flex items-center justify-between sticky top-0 bg-surface">
                <h3 class="font-medium text-body">Tasks</h3>
                <button @click="showTasks = false" class="p-2 text-muted hover:text-body">‚úï</button>
            </div>
            <div class="p-4 animate-pulse space-y-3">
                <div class="h-8 bg-surface-subtle rounded"></div>
                <div class="h-8 bg-surface-subtle rounded"></div>
                <div class="h-8 bg-surface-subtle rounded"></div>
            </div>
        </div>
    </div>

    <div x-show="showAddTask" x-cloak
         class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4"
         @click.self="showAddTask = false"
         @keydown.escape.window="showAddTask = false">
        <div class="bg-surface rounded-xl shadow-2xl border border-border w-full max-w-md">
            <div class="flex items-center justify-between px-6 py-4 border-b border-border">
                <h2 class="h2">New Task</h2>
                <button @click="showAddTask = false" class="text-muted hover:text-body p-1 rounded-md hover:bg-surface-subtle">‚úï</button>
            </div>
            <form @submit.prevent="
                fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(newTask)
                }).then(r => r.json()).then(d => {
                    if (d.success) {
                        window.showToast('Task created', 'success');
                        showAddTask = false;
                        newTask = { description: '', priority: 'medium', due_date: '' };
                        htmx.trigger(document.body, 'refreshTasks');
                    } else {
                        window.showToast(d.error || 'Failed to create task', 'error');
                    }
                });
            " class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-body mb-1">Description</label>
                    <input type="text" 
                           x-model="newTask.description"
                           placeholder="What needs to be done?"
                           class="input-field w-full"
                           required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-body mb-1">Priority</label>
                        <select x-model="newTask.priority" class="input-field w-full">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-body mb-1">Due Date</label>
                        <input type="date" 
                               x-model="newTask.due_date"
                               class="input-field w-full">
                    </div>
                </div>
                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" @click="showAddTask = false" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Create Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function bulkActions() {
    return {
        selected: [],
        
        toggleSelect(uid, folder, checked) {
            if (checked) {
                this.selected.push({ uid, folder });
            } else {
                this.selected = this.selected.filter(e => e.uid !== uid);
            }
        },
        
        toggleAll(checked) {
            if (checked) {
                this.selected = Array.from(document.querySelectorAll('input[data-folder]'))
                    .map(el => ({ uid: el.value, folder: el.dataset.folder }));
            } else {
                this.selected = [];
            }
        },
        
        isSelected(uid) {
            return this.selected.some(e => e.uid === uid);
        },
        
        clearSelection() {
            this.selected = [];
        },
        
        async bulkAction(action) {
            if (this.selected.length === 0) return;
            
            try {
                const response = await fetch(`/api/bulk/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emails: this.selected })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    window.showToast(data.message, 'success');
                    
                    if (action === 'archive' || action === 'delete' || action === 'mark-read' || action === 'mark-unread') {
                        this.selected = [];
                        htmx.trigger('#email-list-container', 'refreshList');
                    } else {
                        this.selected = [];
                    }
                } else {
                    window.showToast(data.message || 'Action failed', 'error');
                }
            } catch (e) {
                window.showToast('Failed to perform action', 'error');
            }
        }
    };
}
</script>
{% endblock %}
