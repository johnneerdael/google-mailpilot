{% extends "base.html" %}

{% block title %}Piper - Email Assistant{% endblock %}

{% block content %}
<div class="flex flex-col h-[calc(100vh-4rem)]">
    <div class="flex items-center justify-between px-6 py-3 border-b border-border">
        <div class="flex items-center gap-3">
            <span class="text-2xl">üê¶</span>
            <h1 class="text-lg font-semibold text-default">Piper</h1>
        </div>
        <div class="flex items-center gap-2">
            <button type="button" onclick="runQuickAction('priority')" class="quick-action-btn group relative" 
                title="Find urgent emails first - questions, deadlines, VIPs. Run this before Clean!">
                ‚ö° Priority
                <span class="tooltip">Identify emails needing your attention</span>
            </button>
            <button type="button" onclick="runQuickAction('clean')" class="quick-action-btn group relative" 
                title="Archive low-priority emails (newsletters, CCs). Best after running Priority.">
                üßπ Clean
                <span class="tooltip">Archive newsletters &amp; noise</span>
            </button>
            <button type="button" onclick="runQuickAction('briefing')" class="quick-action-btn group relative" 
                title="Daily summary of unread emails and calendar events.">
                üì¨ Briefing
                <span class="tooltip">Morning email summary</span>
            </button>
            <div class="w-px h-6 bg-border mx-1"></div>
            <button 
                onclick="clearChat()"
                class="px-3 py-1.5 text-sm text-muted hover:text-default hover:bg-surface-hover rounded-lg transition-colors"
            >
                Clear
            </button>
        </div>
    </div>

    <div id="chat-messages" class="flex-1 overflow-y-auto px-6 py-4 pb-24 space-y-4 bg-canvas">
        <div class="text-center py-8" id="empty-state">
            <div class="text-5xl mb-3">üê¶</div>
            <h2 class="text-xl font-semibold text-default" id="greeting-name">Hey, I'm Piper!</h2>
            <p class="text-muted mt-1" id="greeting-text">Your email co-pilot, ready to help.</p>
            
            <div class="mt-6 bg-surface-dim rounded-xl p-4 text-left max-w-md mx-auto border border-border">
                <h3 class="font-medium text-default mb-2 text-sm">üìö Quick Start Guide</h3>
                <ul class="text-sm text-muted space-y-1.5">
                    <li class="flex items-start gap-2">
                        <span class="text-primary">1.</span>
                        <span><strong>‚ö° Priority</strong> first ‚Äî find urgent emails</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-primary">2.</span>
                        <span><strong>üßπ Clean</strong> second ‚Äî archive the noise</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-primary">3.</span>
                        <span><strong>üì¨ Briefing</strong> anytime ‚Äî daily summary</span>
                    </li>
                </ul>
                <p class="text-xs text-muted mt-3 pt-3 border-t border-border italic">
                    üí° Type <code class="bg-surface px-1 rounded">/</code> for commands
                </p>
            </div>
            
            <div class="mt-6 flex flex-wrap justify-center gap-2">
                <button type="button" onclick="sendSuggestion('What are my unread emails?')" class="suggestion-btn">
                    üì¨ Unread emails
                </button>
                <button type="button" onclick="sendSuggestion('Summarize my inbox from today')" class="suggestion-btn">
                    üìã Summarize today
                </button>
                <button type="button" onclick="sendSuggestion('What meetings do I have this week?')" class="suggestion-btn">
                    üìÖ This week's meetings
                </button>
                <button type="button" onclick="sendSuggestion('Are there any urgent emails I should respond to?')" class="suggestion-btn">
                    üö® Urgent emails
                </button>
            </div>
        </div>
    </div>
    
    <!-- Chat Input Form -->
    <div class="fixed bottom-0 left-0 right-0 bg-surface border-t border-border px-6 py-4">
        <form id="chat-form" onsubmit="sendMessage(event)" class="flex gap-3 max-w-4xl mx-auto">
            <div class="flex-1 relative">
                <input 
                    type="text" 
                    id="message-input" 
                    placeholder="Ask about your emails, or type / for commands..."
                    class="w-full px-4 py-3 bg-canvas border border-border rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-default placeholder-muted"
                    autocomplete="off"
                >
                <div id="slash-menu" class="hidden absolute bottom-full left-0 right-0 mb-2 bg-surface border border-border rounded-lg shadow-lg max-h-64 overflow-y-auto"></div>
            </div>
            <button type="submit" id="send-btn" class="px-6 py-3 bg-primary text-primary-foreground rounded-xl hover:bg-primary/90 transition-colors font-medium">
                Send
            </button>
        </form>
    </div>
</div>

<div id="batch-progress" class="hidden fixed bottom-24 right-6 bg-surface border border-border rounded-lg shadow-lg p-4 w-80 z-50">
    <div class="flex justify-between items-center mb-2">
        <span class="font-medium text-default" id="batch-progress-title">Processing...</span>
        <button onclick="cancelBatch()" class="text-muted hover:text-error text-sm">Cancel</button>
    </div>
    <div class="w-full bg-surface-dim rounded-full h-2">
        <div id="batch-progress-bar" class="bg-primary h-2 rounded-full transition-all" style="width: 0%"></div>
    </div>
    <div class="text-xs text-muted mt-1" id="batch-progress-text">0 / 0 processed</div>
</div>

<div id="batch-approval-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-surface border border-border rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden">
        <div class="px-6 py-4 border-b border-border flex justify-between items-center">
            <h2 class="text-lg font-semibold text-default">üìß Review Items</h2>
            <button onclick="closeBatchApproval()" class="text-muted hover:text-default">&times;</button>
        </div>
        <div id="batch-approval-content" class="p-6 overflow-y-auto max-h-[60vh]"></div>
        <div class="px-6 py-4 border-t border-border flex justify-end gap-3">
            <button onclick="closeBatchApproval()" class="px-4 py-2 text-sm bg-surface-dim hover:bg-surface-hover rounded-lg border border-border">
                Cancel
            </button>
            <button onclick="executeApprovedBatch()" id="approve-batch-btn" class="btn-primary px-4 py-2 text-sm">
                ‚úÖ Approve Selected
            </button>
        </div>
    </div>
</div>

<style>
.quick-action-btn {
    @apply px-3 py-1.5 text-sm bg-surface-dim hover:bg-primary hover:text-primary-foreground rounded-lg transition-colors border border-border relative;
}

.quick-action-btn .tooltip {
    @apply invisible opacity-0 absolute left-1/2 -translate-x-1/2 top-full mt-2 px-3 py-2 text-xs bg-surface border border-border rounded-lg shadow-lg whitespace-nowrap transition-all z-50;
}

.quick-action-btn:hover .tooltip {
    @apply visible opacity-100;
}

.suggestion-btn {
    @apply px-3 py-2 text-sm bg-surface-dim hover:bg-surface-hover text-muted-foreground rounded-lg transition-colors border border-border;
}

.message-user {
    @apply bg-primary text-primary-foreground rounded-2xl rounded-br-sm px-4 py-2 max-w-[80%] ml-auto;
}

.message-assistant {
    @apply bg-surface-dim text-default rounded-2xl rounded-bl-sm px-4 py-2 max-w-[80%] border border-border;
}

.message-assistant pre {
    @apply bg-surface rounded-lg p-3 my-2 overflow-x-auto text-sm border border-border;
}

.message-assistant code {
    @apply bg-surface px-1.5 py-0.5 rounded text-sm font-mono text-primary;
}

.message-assistant ul, .message-assistant ol {
    @apply ml-4 my-2;
}

.message-assistant li {
    @apply my-1;
}

.typing-indicator {
    @apply flex gap-1 items-center px-4 py-3;
}

.typing-indicator span {
    @apply w-2 h-2 bg-muted rounded-full animate-bounce;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.1s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.2s;
}
</style>

<script>
const messagesContainer = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const emptyState = document.getElementById('empty-state');
const chatForm = document.getElementById('chat-form');

function hideEmptyState() {
    if (emptyState) {
        emptyState.style.display = 'none';
    }
}

function addMessage(role, content) {
    hideEmptyState();
    
    const div = document.createElement('div');
    div.className = role === 'user' ? 'message-user' : 'message-assistant';
    
    if (role === 'assistant') {
        div.innerHTML = formatMarkdown(content);
    } else {
        div.textContent = content;
    }
    
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return div;
}

function addTypingIndicator() {
    hideEmptyState();
    
    const div = document.createElement('div');
    div.className = 'message-assistant typing-indicator';
    div.id = 'typing-indicator';
    div.innerHTML = '<span></span><span></span><span></span>';
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function removeTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) {
        indicator.remove();
    }
}

function formatMarkdown(text) {
    let html = text
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/_(.+?)_/g, '<em>$1</em>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>')
        .replace(/\n/g, '<br>');
    
    return html;
}

function setLoading(loading) {
    sendBtn.disabled = loading;
    messageInput.disabled = loading;
    if (loading) {
        sendBtn.textContent = '...';
    } else {
        sendBtn.textContent = 'Send';
    }
}

async function sendMessage(event) {
    // Only call preventDefault on real form submit events
    if (event && event.preventDefault) {
        event.preventDefault();
    }
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    messageInput.value = '';
    addMessage('user', message);
    setLoading(true);
    addTypingIndicator();
    
    try {
        const formData = new FormData();
        formData.append('message', message);
        
        const response = await fetch('/api/chat/stream', {
            method: 'POST',
            body: formData,
        });
        
        removeTypingIndicator();
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        let assistantDiv = null;
        let fullContent = '';
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const data = line.slice(6);
                    if (data === '[DONE]') {
                        break;
                    }
                    
                    try {
                        const event = JSON.parse(data);
                        
                        // Handle different event types from LangGraph
                        if (event.type === 'token' && event.content) {
                            fullContent += event.content;
                            
                            if (!assistantDiv) {
                                assistantDiv = addMessage('assistant', '');
                            }
                            assistantDiv.innerHTML = formatMarkdown(fullContent);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        } else if (event.type === 'tool_start') {
                            // Show tool execution indicator
                            if (!assistantDiv) {
                                assistantDiv = addMessage('assistant', '');
                            }
                            const toolIndicator = `üîß Using ${event.tool}...\n`;
                            assistantDiv.innerHTML = formatMarkdown(fullContent + toolIndicator);
                        } else if (event.type === 'tool_end') {
                            // Tool finished - continue showing content
                        } else if (event.type === 'interrupt') {
                            // HITL - show approval UI
                            showApprovalDialog(event.tool, event.args);
                        } else if (event.type === 'error') {
                            fullContent += `\n‚ùå Error: ${event.message}`;
                            if (!assistantDiv) {
                                assistantDiv = addMessage('assistant', '');
                            }
                            assistantDiv.innerHTML = formatMarkdown(fullContent);
                        } else if (event.type === 'done') {
                            // Stream complete
                        } else if (event.type === 'batch_progress') {
                            showBatchProgress(event.tool, event.processed, event.total_estimate);
                        } else if (event.type === 'batch_complete') {
                            hideBatchProgress();
                            if (event.items && event.items.length > 0) {
                                showBatchApprovalDialog(event.items);
                            } else {
                                fullContent += '\n‚úÖ Batch scan complete. No items found matching criteria.';
                                if (!assistantDiv) assistantDiv = addMessage('assistant', '');
                                assistantDiv.innerHTML = formatMarkdown(fullContent);
                            }
                        } else if (typeof event === 'string') {
                            // Fallback for old format (plain string)
                            fullContent += event;
                            if (!assistantDiv) {
                                assistantDiv = addMessage('assistant', '');
                            }
                            assistantDiv.innerHTML = formatMarkdown(fullContent);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                    } catch (e) {
                        // Try as plain text (old format fallback)
                        if (data && data !== '[DONE]') {
                            fullContent += data;
                            if (!assistantDiv) {
                                assistantDiv = addMessage('assistant', '');
                            }
                            assistantDiv.innerHTML = formatMarkdown(fullContent);
                        }
                    }
                }
            }
        }
        
        if (!assistantDiv && fullContent) {
            addMessage('assistant', fullContent);
        }
        
    } catch (error) {
        removeTypingIndicator();
        addMessage('assistant', `Error: ${error.message}. Please try again.`);
    } finally {
        setLoading(false);
        messageInput.focus();
    }
}

function sendSuggestion(text) {
    messageInput.value = text;
    // Call sendMessage directly without event (no form submission to prevent)
    sendMessage();
}

function showApprovalDialog(tool, args) {
    hideEmptyState();
    
    const div = document.createElement('div');
    div.className = 'message-assistant';
    div.innerHTML = `
        <div class="mb-3">
            <strong>üîê Approval Required</strong>
            <p class="text-sm text-muted mt-1">The assistant wants to execute:</p>
        </div>
        <div class="bg-surface rounded-lg p-3 mb-3 border border-border">
            <code class="text-sm">${tool}</code>
            <pre class="text-xs mt-2 overflow-x-auto">${JSON.stringify(args, null, 2)}</pre>
        </div>
        <div class="flex gap-2">
            <button onclick="approveAction(this)" class="btn-primary px-4 py-2 text-sm">
                ‚úÖ Approve
            </button>
            <button onclick="rejectAction(this)" class="px-4 py-2 text-sm bg-surface-dim hover:bg-surface-hover rounded-lg border border-border">
                ‚ùå Reject
            </button>
        </div>
    `;
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

async function approveAction(btn) {
    const container = btn.closest('.message-assistant');
    container.innerHTML = '<p class="text-muted">‚è≥ Executing approved action...</p>';
    
    try {
        const response = await fetch('/api/chat/approve', {
            method: 'POST',
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullContent = '';
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const data = line.slice(6);
                    if (data === '[DONE]') break;
                    
                    try {
                        const event = JSON.parse(data);
                        if (event.type === 'token' && event.content) {
                            fullContent += event.content;
                            container.innerHTML = formatMarkdown(fullContent);
                        } else if (event.type === 'interrupt') {
                            showApprovalDialog(event.tool, event.args);
                            return;
                        }
                    } catch (e) {}
                }
            }
        }
        
        if (fullContent) {
            container.innerHTML = formatMarkdown(fullContent);
        } else {
            container.innerHTML = '<p class="text-success">‚úÖ Action completed successfully.</p>';
        }
        
    } catch (error) {
        container.innerHTML = `<p class="text-error">‚ùå Error: ${error.message}</p>`;
    }
}

async function rejectAction(btn) {
    const container = btn.closest('.message-assistant');
    
    try {
        const formData = new FormData();
        formData.append('reason', 'User declined');
        
        const response = await fetch('/api/chat/reject', {
            method: 'POST',
            body: formData,
        });
        
        const data = await response.json();
        container.innerHTML = `<p class="text-muted">üö´ Action rejected: ${data.message || 'User declined'}</p>`;
        
    } catch (error) {
        container.innerHTML = `<p class="text-error">‚ùå Error rejecting: ${error.message}</p>`;
    }
}

async function clearChat() {
    try {
        await fetch('/api/chat/clear', { method: 'POST' });
        messagesContainer.innerHTML = '';
        if (emptyState) {
            emptyState.style.display = 'block';
            messagesContainer.appendChild(emptyState);
        }
    } catch (error) {
        console.error('Failed to clear chat:', error);
    }
}

async function loadHistory() {
    try {
        const response = await fetch('/api/chat/history');
        const data = await response.json();
        
        if (data.messages && data.messages.length > 0) {
            hideEmptyState();
            for (const msg of data.messages) {
                addMessage(msg.role, msg.content);
            }
        }
    } catch (error) {
        console.error('Failed to load history:', error);
    }
}

document.addEventListener('keydown', (e) => {
    if (e.key === '/' && document.activeElement !== messageInput) {
        e.preventDefault();
        messageInput.focus();
    }
});

let currentBatchItems = [];
let selectedBatchUids = new Set();

function runQuickAction(action) {
    const prompts = {
        'clean': 'Clean my inbox - identify emails I can safely archive using quick_clean_inbox',
        'priority': 'Triage my inbox and identify priority emails using triage_priority_emails',
        'briefing': 'Give me my morning briefing with unread emails and today\'s calendar'
    };
    
    const prompt = prompts[action];
    if (prompt) {
        messageInput.value = prompt;
        // Call sendMessage directly without event (no form submission to prevent)
        sendMessage();
    }
}

function showBatchProgress(title, processed, total) {
    const container = document.getElementById('batch-progress');
    const titleEl = document.getElementById('batch-progress-title');
    const barEl = document.getElementById('batch-progress-bar');
    const textEl = document.getElementById('batch-progress-text');
    
    container.classList.remove('hidden');
    titleEl.textContent = title;
    const pct = total > 0 ? Math.round((processed / total) * 100) : 0;
    barEl.style.width = pct + '%';
    textEl.textContent = `${processed} / ${total} processed`;
}

function hideBatchProgress() {
    document.getElementById('batch-progress').classList.add('hidden');
}

async function cancelBatch() {
    try {
        await fetch('/api/chat/batch/cancel', { method: 'POST' });
        hideBatchProgress();
        addMessage('assistant', 'üõë Batch operation cancelled.');
    } catch (error) {
        console.error('Failed to cancel batch:', error);
    }
}

function showBatchApprovalDialog(items) {
    currentBatchItems = items;
    selectedBatchUids = new Set(items.map(i => i.uid));
    
    const grouped = { high: [], medium: [], low: [] };
    items.forEach(item => {
        const conf = item.confidence || 'medium';
        if (grouped[conf]) grouped[conf].push(item);
        else grouped.medium.push(item);
    });
    
    let html = '';
    
    for (const [level, levelItems] of Object.entries(grouped)) {
        if (levelItems.length === 0) continue;
        
        const icons = { high: 'üü¢', medium: 'üü°', low: 'üî¥' };
        const labels = { high: 'High Confidence', medium: 'Medium Confidence', low: 'Low Confidence' };
        
        html += `
            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-medium text-default">${icons[level]} ${labels[level]} (${levelItems.length})</h3>
                    <label class="text-sm text-muted">
                        <input type="checkbox" checked onchange="toggleConfidenceLevel('${level}', this.checked)" class="mr-1">
                        Select all
                    </label>
                </div>
                <div class="space-y-2 max-h-48 overflow-y-auto">
        `;
        
        for (const item of levelItems) {
            const preview = level !== 'high' && item.preview ? `<p class="text-xs text-muted mt-1 line-clamp-2">${escapeHtml(item.preview.slice(0, 200))}</p>` : '';
            html += `
                <div class="flex items-start gap-2 p-2 bg-surface-dim rounded-lg text-sm">
                    <input type="checkbox" checked data-uid="${item.uid}" data-confidence="${level}" onchange="toggleBatchItem('${item.uid}', this.checked)" class="mt-1">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between">
                            <span class="font-medium truncate">${escapeHtml(item.from_addr || 'Unknown')}</span>
                            <span class="text-xs text-muted">${item.date || ''}</span>
                        </div>
                        <p class="truncate text-muted">${escapeHtml(item.subject || 'No subject')}</p>
                        ${preview}
                    </div>
                </div>
            `;
        }
        
        html += '</div></div>';
    }
    
    if (html === '') {
        html = '<p class="text-muted">No items to review.</p>';
    }
    
    document.getElementById('batch-approval-content').innerHTML = html;
    document.getElementById('batch-approval-modal').classList.remove('hidden');
    updateApproveButtonCount();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function toggleConfidenceLevel(level, checked) {
    const checkboxes = document.querySelectorAll(`input[data-confidence="${level}"]`);
    checkboxes.forEach(cb => {
        cb.checked = checked;
        toggleBatchItem(cb.dataset.uid, checked);
    });
}

function toggleBatchItem(uid, checked) {
    if (checked) {
        selectedBatchUids.add(uid);
    } else {
        selectedBatchUids.delete(uid);
    }
    updateApproveButtonCount();
}

function updateApproveButtonCount() {
    const btn = document.getElementById('approve-batch-btn');
    btn.textContent = `‚úÖ Approve Selected (${selectedBatchUids.size})`;
}

function closeBatchApproval() {
    document.getElementById('batch-approval-modal').classList.add('hidden');
    currentBatchItems = [];
    selectedBatchUids.clear();
}

async function executeApprovedBatch() {
    if (selectedBatchUids.size === 0) {
        alert('No items selected');
        return;
    }
    
    closeBatchApproval();
    showBatchProgress('Executing...', 0, selectedBatchUids.size);
    
    try {
        const formData = new FormData();
        formData.append('uids', JSON.stringify([...selectedBatchUids]));
        formData.append('action', 'archive');
        formData.append('folder', 'INBOX');
        
        const response = await fetch('/api/chat/batch/approve', {
            method: 'POST',
            body: formData,
        });
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            for (const line of chunk.split('\n')) {
                if (line.startsWith('data: ')) {
                    const data = line.slice(6);
                    if (data === '[DONE]') break;
                    
                    try {
                        const event = JSON.parse(data);
                        if (event.type === 'batch_execute_progress') {
                            showBatchProgress('Executing...', event.processed, event.total);
                        } else if (event.type === 'batch_execute_complete') {
                            hideBatchProgress();
                            addMessage('assistant', `‚úÖ Batch complete: ${event.success} processed, ${event.errors} errors.`);
                        }
                    } catch (e) {}
                }
            }
        }
    } catch (error) {
        hideBatchProgress();
        addMessage('assistant', `‚ùå Error: ${error.message}`);
    }
}

const SLASH_COMMANDS = [
    { cmd: '/priority', desc: 'Find urgent emails needing attention', prereq: null, action: 'priority' },
    { cmd: '/clean', desc: 'Archive newsletters & low-priority emails', prereq: '/priority', action: 'clean' },
    { cmd: '/briefing', desc: 'Daily summary of emails & calendar', prereq: null, action: 'briefing' },
    { cmd: '/remaining', desc: 'Process emails needing human decision', prereq: '/priority', action: 'remaining' },
    { cmd: '/drafts', desc: 'Check emails that need a reply', prereq: null, action: 'drafts' },
    { cmd: '/unread', desc: 'Show all unread emails', prereq: null, action: 'unread' },
];

const slashMenu = document.getElementById('slash-menu');

function showSlashMenu(filter) {
    const filtered = SLASH_COMMANDS.filter(c => c.cmd.slice(1).startsWith(filter.toLowerCase()));
    
    if (filtered.length === 0) {
        hideSlashMenu();
        return;
    }
    
    slashMenu.innerHTML = filtered.map((c, i) => `
        <div class="slash-item px-4 py-2 hover:bg-surface-hover cursor-pointer ${i === 0 ? 'bg-surface-hover' : ''}" 
             data-cmd="${c.cmd}" data-action="${c.action}" data-prereq="${c.prereq || ''}">
            <div class="flex items-center justify-between">
                <span class="font-mono text-sm text-primary">${c.cmd}</span>
                ${c.prereq ? '<span class="text-xs text-warning">‚ö†Ô∏è Run ' + c.prereq + ' first</span>' : ''}
            </div>
            <p class="text-xs text-muted">${c.desc}</p>
        </div>
    `).join('');
    
    slashMenu.classList.remove('hidden');
    
    slashMenu.querySelectorAll('.slash-item').forEach(item => {
        item.addEventListener('click', () => selectSlashCommand(item.dataset.cmd, item.dataset.action, item.dataset.prereq));
    });
}

function hideSlashMenu() {
    slashMenu.classList.add('hidden');
}

function selectSlashCommand(cmd, action, prereq) {
    hideSlashMenu();
    
    if (prereq && prereq !== 'null') {
        showPrereqPrompt(cmd, action, prereq);
    } else {
        executeSlashCommand(action);
    }
}

function showPrereqPrompt(cmd, action, prereq) {
    hideEmptyState();
    
    const div = document.createElement('div');
    div.className = 'message-assistant';
    div.innerHTML = `
        <div class="mb-3">
            <strong>‚ö†Ô∏è Recommended Order</strong>
            <p class="text-sm text-muted mt-1">For best results, run <code class="bg-surface px-1 rounded">${prereq}</code> before <code class="bg-surface px-1 rounded">${cmd}</code>.</p>
        </div>
        <div class="flex gap-2">
            <button onclick="executeSlashCommand('${prereq.slice(1)}'); this.closest('.message-assistant').remove();" class="btn-primary px-4 py-2 text-sm">
                Run ${prereq} first
            </button>
            <button onclick="executeSlashCommand('${action}'); this.closest('.message-assistant').remove();" class="px-4 py-2 text-sm bg-surface-dim hover:bg-surface-hover rounded-lg border border-border">
                Continue with ${cmd}
            </button>
        </div>
    `;
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function executeSlashCommand(action) {
    const commands = {
        'priority': 'Triage my inbox and identify priority emails using triage_priority_emails',
        'clean': 'Clean my inbox - identify emails I can safely archive using quick_clean_inbox',
        'briefing': 'Give me my morning briefing with unread emails and today\'s calendar',
        'remaining': 'Process remaining emails that need my decision using triage_remaining_emails',
        'drafts': 'Check for emails that need a response using check_emails_needing_response',
        'unread': 'What are my unread emails?',
    };
    
    const prompt = commands[action];
    if (prompt) {
        messageInput.value = prompt;
        // Call sendMessage directly without event (no form submission to prevent)
        sendMessage();
    }
}

messageInput.addEventListener('input', (e) => {
    const val = e.target.value;
    if (val.startsWith('/')) {
        showSlashMenu(val.slice(1));
    } else {
        hideSlashMenu();
    }
});

messageInput.addEventListener('keydown', (e) => {
    if (!slashMenu.classList.contains('hidden')) {
        const items = slashMenu.querySelectorAll('.slash-item');
        const current = slashMenu.querySelector('.slash-item.bg-surface-hover');
        const currentIdx = Array.from(items).indexOf(current);
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            current?.classList.remove('bg-surface-hover');
            items[(currentIdx + 1) % items.length]?.classList.add('bg-surface-hover');
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            current?.classList.remove('bg-surface-hover');
            items[(currentIdx - 1 + items.length) % items.length]?.classList.add('bg-surface-hover');
        } else if (e.key === 'Enter' && current) {
            e.preventDefault();
            selectSlashCommand(current.dataset.cmd, current.dataset.action, current.dataset.prereq);
        } else if (e.key === 'Escape') {
            hideSlashMenu();
        }
    }
});

const SESSION_KEY = 'piper_session_id';
let piperSessionId = localStorage.getItem(SESSION_KEY);
if (!piperSessionId) {
    piperSessionId = 'piper-' + Date.now() + '-' + Math.random().toString(36).slice(2, 9);
    localStorage.setItem(SESSION_KEY, piperSessionId);
}

async function loadDynamicGreeting() {
    try {
        const response = await fetch('/api/chat/greeting?session_id=' + encodeURIComponent(piperSessionId));
        if (response.ok) {
            const data = await response.json();
            if (data.greeting) {
                document.getElementById('greeting-text').textContent = data.greeting;
            }
        }
    } catch (e) {
        console.log('Using default greeting');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    loadHistory();
    loadDynamicGreeting();
    if (messageInput) messageInput.focus();
});
</script>
{% endblock %}
