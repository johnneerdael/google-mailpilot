{% extends "base.html" %}

{% block title %}AI Assistant - Secretary{% endblock %}

{% block content %}
<div class="flex flex-col h-[calc(100vh-4rem)]">
    <div class="flex items-center justify-between px-6 py-3 border-b border-border">
        <div class="flex items-center gap-3">
            <span class="text-2xl">ü§ñ</span>
            <h1 class="text-lg font-semibold text-default">AI Assistant</h1>
        </div>
        <button 
            onclick="clearChat()"
            class="px-3 py-1.5 text-sm text-muted hover:text-default hover:bg-surface-hover rounded-lg transition-colors"
        >
            Clear Chat
        </button>
    </div>

    <div id="chat-messages" class="flex-1 overflow-y-auto px-6 py-4 space-y-4 bg-canvas">
        <div class="text-center text-muted py-8" id="empty-state">
            <div class="text-4xl mb-3">üí¨</div>
            <p class="text-lg">How can I help you today?</p>
            <p class="text-sm mt-2">Ask me about your emails, calendar, or let me help draft replies.</p>
            
            <div class="mt-6 flex flex-wrap justify-center gap-2">
                <button onclick="sendSuggestion('What are my unread emails?')" class="suggestion-btn">
                    üì¨ Unread emails
                </button>
                <button onclick="sendSuggestion('Summarize my inbox from today')" class="suggestion-btn">
                    üìã Summarize today
                </button>
                <button onclick="sendSuggestion('What meetings do I have this week?')" class="suggestion-btn">
                    üìÖ This week's meetings
                </button>
                <button onclick="sendSuggestion('Are there any urgent emails I should respond to?')" class="suggestion-btn">
                    üö® Urgent emails
                </button>
            </div>
        </div>
    </div>

    <div class="border-t border-border px-6 py-4">
        <form id="chat-form" onsubmit="sendMessage(event)" class="flex gap-3">
            <input 
                type="text" 
                id="message-input"
                name="message"
                placeholder="Ask about your emails, calendar, or request help..."
                class="input-field flex-1"
                autocomplete="off"
            >
            <button 
                type="submit"
                id="send-btn"
                class="btn-primary px-6 py-3 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                Send
            </button>
        </form>
    </div>
</div>

<style>
.suggestion-btn {
    @apply px-3 py-2 text-sm bg-surface-dim hover:bg-surface-hover text-muted-foreground rounded-lg transition-colors border border-border;
}

.message-user {
    @apply bg-primary text-primary-foreground rounded-2xl rounded-br-sm px-4 py-2 max-w-[80%] ml-auto;
}

.message-assistant {
    @apply bg-surface-dim text-default rounded-2xl rounded-bl-sm px-4 py-2 max-w-[80%] border border-border;
}

.message-assistant pre {
    @apply bg-surface rounded-lg p-3 my-2 overflow-x-auto text-sm border border-border;
}

.message-assistant code {
    @apply bg-surface px-1.5 py-0.5 rounded text-sm font-mono text-primary;
}

.message-assistant ul, .message-assistant ol {
    @apply ml-4 my-2;
}

.message-assistant li {
    @apply my-1;
}

.typing-indicator {
    @apply flex gap-1 items-center px-4 py-3;
}

.typing-indicator span {
    @apply w-2 h-2 bg-muted rounded-full animate-bounce;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.1s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.2s;
}
</style>

<script>
const messagesContainer = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const emptyState = document.getElementById('empty-state');
const chatForm = document.getElementById('chat-form');

function hideEmptyState() {
    if (emptyState) {
        emptyState.style.display = 'none';
    }
}

function addMessage(role, content) {
    hideEmptyState();
    
    const div = document.createElement('div');
    div.className = role === 'user' ? 'message-user' : 'message-assistant';
    
    if (role === 'assistant') {
        div.innerHTML = formatMarkdown(content);
    } else {
        div.textContent = content;
    }
    
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return div;
}

function addTypingIndicator() {
    hideEmptyState();
    
    const div = document.createElement('div');
    div.className = 'message-assistant typing-indicator';
    div.id = 'typing-indicator';
    div.innerHTML = '<span></span><span></span><span></span>';
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function removeTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) {
        indicator.remove();
    }
}

function formatMarkdown(text) {
    let html = text
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/_(.+?)_/g, '<em>$1</em>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>')
        .replace(/\n/g, '<br>');
    
    return html;
}

function setLoading(loading) {
    sendBtn.disabled = loading;
    messageInput.disabled = loading;
    if (loading) {
        sendBtn.textContent = '...';
    } else {
        sendBtn.textContent = 'Send';
    }
}

async function sendMessage(event) {
    event.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    messageInput.value = '';
    addMessage('user', message);
    setLoading(true);
    addTypingIndicator();
    
    try {
        const formData = new FormData();
        formData.append('message', message);
        
        const response = await fetch('/api/chat/stream', {
            method: 'POST',
            body: formData,
        });
        
        removeTypingIndicator();
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        let assistantDiv = null;
        let fullContent = '';
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const data = line.slice(6);
                    if (data === '[DONE]') {
                        break;
                    }
                    
                    try {
                        const event = JSON.parse(data);
                        
                        // Handle different event types from LangGraph
                        if (event.type === 'token' && event.content) {
                            fullContent += event.content;
                            
                            if (!assistantDiv) {
                                assistantDiv = addMessage('assistant', '');
                            }
                            assistantDiv.innerHTML = formatMarkdown(fullContent);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        } else if (event.type === 'tool_start') {
                            // Show tool execution indicator
                            if (!assistantDiv) {
                                assistantDiv = addMessage('assistant', '');
                            }
                            const toolIndicator = `üîß Using ${event.tool}...\n`;
                            assistantDiv.innerHTML = formatMarkdown(fullContent + toolIndicator);
                        } else if (event.type === 'tool_end') {
                            // Tool finished - continue showing content
                        } else if (event.type === 'interrupt') {
                            // HITL - show approval UI
                            showApprovalDialog(event.tool, event.args);
                        } else if (event.type === 'error') {
                            fullContent += `\n‚ùå Error: ${event.message}`;
                            if (!assistantDiv) {
                                assistantDiv = addMessage('assistant', '');
                            }
                            assistantDiv.innerHTML = formatMarkdown(fullContent);
                        } else if (event.type === 'done') {
                            // Stream complete
                        } else if (typeof event === 'string') {
                            // Fallback for old format (plain string)
                            fullContent += event;
                            if (!assistantDiv) {
                                assistantDiv = addMessage('assistant', '');
                            }
                            assistantDiv.innerHTML = formatMarkdown(fullContent);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                    } catch (e) {
                        // Try as plain text (old format fallback)
                        if (data && data !== '[DONE]') {
                            fullContent += data;
                            if (!assistantDiv) {
                                assistantDiv = addMessage('assistant', '');
                            }
                            assistantDiv.innerHTML = formatMarkdown(fullContent);
                        }
                    }
                }
            }
        }
        
        if (!assistantDiv && fullContent) {
            addMessage('assistant', fullContent);
        }
        
    } catch (error) {
        removeTypingIndicator();
        addMessage('assistant', `Error: ${error.message}. Please try again.`);
    } finally {
        setLoading(false);
        messageInput.focus();
    }
}

function sendSuggestion(text) {
    messageInput.value = text;
    chatForm.dispatchEvent(new Event('submit'));
}

function showApprovalDialog(tool, args) {
    hideEmptyState();
    
    const div = document.createElement('div');
    div.className = 'message-assistant';
    div.innerHTML = `
        <div class="mb-3">
            <strong>üîê Approval Required</strong>
            <p class="text-sm text-muted mt-1">The assistant wants to execute:</p>
        </div>
        <div class="bg-surface rounded-lg p-3 mb-3 border border-border">
            <code class="text-sm">${tool}</code>
            <pre class="text-xs mt-2 overflow-x-auto">${JSON.stringify(args, null, 2)}</pre>
        </div>
        <div class="flex gap-2">
            <button onclick="approveAction(this)" class="btn-primary px-4 py-2 text-sm">
                ‚úÖ Approve
            </button>
            <button onclick="rejectAction(this)" class="px-4 py-2 text-sm bg-surface-dim hover:bg-surface-hover rounded-lg border border-border">
                ‚ùå Reject
            </button>
        </div>
    `;
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

async function approveAction(btn) {
    const container = btn.closest('.message-assistant');
    container.innerHTML = '<p class="text-muted">‚è≥ Executing approved action...</p>';
    
    try {
        const response = await fetch('/api/chat/approve', {
            method: 'POST',
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullContent = '';
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const data = line.slice(6);
                    if (data === '[DONE]') break;
                    
                    try {
                        const event = JSON.parse(data);
                        if (event.type === 'token' && event.content) {
                            fullContent += event.content;
                            container.innerHTML = formatMarkdown(fullContent);
                        } else if (event.type === 'interrupt') {
                            showApprovalDialog(event.tool, event.args);
                            return;
                        }
                    } catch (e) {}
                }
            }
        }
        
        if (fullContent) {
            container.innerHTML = formatMarkdown(fullContent);
        } else {
            container.innerHTML = '<p class="text-success">‚úÖ Action completed successfully.</p>';
        }
        
    } catch (error) {
        container.innerHTML = `<p class="text-error">‚ùå Error: ${error.message}</p>`;
    }
}

async function rejectAction(btn) {
    const container = btn.closest('.message-assistant');
    
    try {
        const formData = new FormData();
        formData.append('reason', 'User declined');
        
        const response = await fetch('/api/chat/reject', {
            method: 'POST',
            body: formData,
        });
        
        const data = await response.json();
        container.innerHTML = `<p class="text-muted">üö´ Action rejected: ${data.message || 'User declined'}</p>`;
        
    } catch (error) {
        container.innerHTML = `<p class="text-error">‚ùå Error rejecting: ${error.message}</p>`;
    }
}

async function clearChat() {
    try {
        await fetch('/api/chat/clear', { method: 'POST' });
        messagesContainer.innerHTML = '';
        if (emptyState) {
            emptyState.style.display = 'block';
            messagesContainer.appendChild(emptyState);
        }
    } catch (error) {
        console.error('Failed to clear chat:', error);
    }
}

async function loadHistory() {
    try {
        const response = await fetch('/api/chat/history');
        const data = await response.json();
        
        if (data.messages && data.messages.length > 0) {
            hideEmptyState();
            for (const msg of data.messages) {
                addMessage(msg.role, msg.content);
            }
        }
    } catch (error) {
        console.error('Failed to load history:', error);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    loadHistory();
    messageInput.focus();
});

document.addEventListener('keydown', (e) => {
    if (e.key === '/' && document.activeElement !== messageInput) {
        e.preventDefault();
        messageInput.focus();
    }
});
</script>
{% endblock %}
